<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master √ìleo Curitiba - Sistema de Gest√£o</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .stat {
            text-align: center;
            padding: 10px 20px;
            background: #f7fafc;
            border-radius: 10px;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .btn-danger:hover {
            background: #e53e3e;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            position: relative;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .card-aguardando {
            border-left: 5px solid #f6ad55;
        }
        
        .card-concluido {
            border-left: 5px solid #48bb78;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .order-number {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .queue-position {
            background: #f6ad55;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .card-title {
            font-size: 20px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .card-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .info-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #4a5568;
        }
        
        .info-label {
            font-weight: 600;
            color: #2d3748;
        }
        
        .services-list {
            background: #f7fafc;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .service-item {
            font-size: 13px;
            color: #4a5568;
            padding: 3px 0;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-upsell {
            background: #ffd700;
            color: #744210;
        }
        
        .badge-problem {
            background: #fc8181;
            color: #742a2a;
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            padding: 25px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #718096;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: #f7fafc;
            color: #2d3748;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .checkbox-group:hover {
            background: #edf2f7;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            cursor: pointer;
            font-weight: 500;
            flex: 1;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
        }
        
        .step {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .step-number {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #e2e8f0;
            color: #718096;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .step.active .step-number {
            background: #667eea;
            color: white;
        }
        
        .step.completed .step-number {
            background: #48bb78;
            color: white;
        }
        
        .step-label {
            font-weight: 600;
            color: #718096;
        }
        
        .step.active .step-label {
            color: #667eea;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }
        
        .alert-warning {
            background: #feebc8;
            color: #744210;
            border-left: 4px solid #f6ad55;
        }
        
        .alert-danger {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }
        
        .alert-info {
            background: #bee3f8;
            color: #2c5282;
            border-left: 4px solid #4299e1;
        }
        
        .photo-upload {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .photo-upload:hover {
            border-color: #667eea;
            background: #f7fafc;
        }
        
        .photo-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #2d3748;
            margin: 20px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .value-display {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .value-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 16px;
        }
        
        .value-label {
            font-weight: 600;
            color: #4a5568;
        }
        
        .value-amount {
            font-weight: bold;
            color: #2d3748;
        }
        
        .value-total {
            border-top: 2px solid #cbd5e0;
            padding-top: 12px;
            margin-top: 8px;
        }
        
        .value-total .value-amount {
            color: #667eea;
            font-size: 20px;
        }
        
        @media (max-width: 768px) {
            .cards-container {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDGKmHDcq4ErMxiovaZJl7W2aASQ_WqgGY",
            authDomain: "masteroleo-1ed99.firebaseapp.com",
            projectId: "masteroleo-1ed99",
            storageBucket: "masteroleo-1ed99.firebasestorage.app",
            messagingSenderId: "242752297319",
            appId: "1:242752297319:web:e6384e400ba2abc2aa37c2",
            measurementId: "G-QL78TZBW3V"
        };

        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // ============================================
        // CONFIGURA√á√ïES GLOBAIS DO SISTEMA
        // ============================================
        const SYSTEM_CONFIG = {
            // URL do webhook do Google Apps Script (PREENCHER DEPOIS DO DEPLOY)
            SHEETS_WEBHOOK_URL: localStorage.getItem('sheetsWebhookUrl') || 'https://script.google.com/macros/s/AKfycbxhYQblbrch4KZ_fRAeKlHqV8-h4d1EzRRIWklQoHZIJ8iGg_0IKhgTN7HX35aCPIhx/exec',
            
            // Senha para acessar configura√ß√µes
            ADMIN_PASSWORD: 'admin2026',
            
            // Metas por t√©cnico (salvas em localStorage)
            METAS: JSON.parse(localStorage.getItem('metasTecnicos') || JSON.stringify({
                'Caio': { ofertas: 90, upsell: 45 },
                'Luis': { ofertas: 90, upsell: 45 },
                'Pedro': { ofertas: 90, upsell: 45 }
            })),
            
            // M√äS VIGENTE PARA AVALIA√á√ÉO (NOVO!)
            MES_VIGENTE: JSON.parse(localStorage.getItem('mesVigente') || JSON.stringify({
                mes: new Date().getMonth() + 1, // 1-12
                ano: new Date().getFullYear()
            })),
            
            // Alertas habilitados
            ALERTAS_ENABLED: localStorage.getItem('alertasEnabled') !== 'false'
        };

        // Helper: Salvar m√™s vigente
        const salvarMesVigente = (mes, ano) => {
            const mesVigente = { mes: parseInt(mes), ano: parseInt(ano) };
            localStorage.setItem('mesVigente', JSON.stringify(mesVigente));
            SYSTEM_CONFIG.MES_VIGENTE = mesVigente;
        };

        // Helper: Obter nome do m√™s
        const getNomeMes = (mes) => {
            const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            return meses[mes - 1];
        };

        // ============================================
        // FUN√á√ïES DE INTEGRA√á√ÉO COM GOOGLE SHEETS
        // ============================================
        
        // Sincronizar ordem com Google Sheets
        const syncToSheets = async (action, order) => {
            if (!SYSTEM_CONFIG.SHEETS_WEBHOOK_URL) {
                console.log('‚ö†Ô∏è Webhook do Sheets n√£o configurado');
                return;
            }
            
            try {
                console.log(`üì§ Enviando para Sheets: ${action}`, order);
                
                const response = await fetch(SYSTEM_CONFIG.SHEETS_WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Apps Script requer no-cors
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action, // 'create', 'update', 'delete'
                        order: order
                    })
                });
                
                console.log('‚úÖ Sincronizado com Sheets');
            } catch (error) {
                console.error('‚ùå Erro ao sincronizar com Sheets:', error);
            }
        };

        // Salvar metas no localStorage
        const salvarMetas = (metas) => {
            localStorage.setItem('metasTecnicos', JSON.stringify(metas));
            SYSTEM_CONFIG.METAS = metas;
        };

        // Salvar URL do webhook
        const salvarWebhookUrl = (url) => {
            localStorage.setItem('sheetsWebhookUrl', url);
            SYSTEM_CONFIG.SHEETS_WEBHOOK_URL = url;
        };

        // Fun√ß√£o para obter data/hora no hor√°rio de Bras√≠lia
        const getBrasilDateTime = () => {
            return new Date().toLocaleString('pt-BR', {
                timeZone: 'America/Sao_Paulo',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        };

        // Fun√ß√£o para formatar data/hora para input
        const formatDateTimeForInput = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        };

        // Fun√ß√£o para calcular diferen√ßa de tempo (CORRIGIDA)
        const calcularDiferencaTempo = (inicio, fim) => {
            try {
                if (!inicio || !fim) return 'N/A';
                
                // Fun√ß√£o auxiliar para converter string BR para Date
                const parseDataBR = (str) => {
                    // Formato esperado: "DD/MM/YYYY HH:mm:ss" ou "DD/MM/YYYY, HH:mm:ss"
                    const cleaned = str.replace(',', '').trim();
                    const match = cleaned.match(/(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2}):(\d{2})/);
                    if (!match) {
                        // Tentar parse direto se for ISO
                        return new Date(str);
                    }
                    const [_, dia, mes, ano, hora, min, seg] = match;
                    return new Date(`${ano}-${mes}-${dia}T${hora}:${min}:${seg}`);
                };
                
                const dataInicio = parseDataBR(inicio);
                const dataFim = parseDataBR(fim);
                
                // Validar datas
                if (isNaN(dataInicio.getTime()) || isNaN(dataFim.getTime())) {
                    console.warn('Datas inv√°lidas:', { inicio, fim });
                    return 'N/A';
                }
                
                const diffMs = dataFim - dataInicio;
                
                // Validar diferen√ßa
                if (diffMs < 0) {
                    console.warn('Fim antes de in√≠cio:', { inicio, fim });
                    return 'N/A';
                }
                
                const diffMinutes = Math.floor(diffMs / 60000);
                const hours = Math.floor(diffMinutes / 60);
                const minutes = diffMinutes % 60;
                
                return `${hours}h ${minutes}min`;
            } catch (error) {
                console.error('Erro ao calcular tempo:', error, { inicio, fim });
                return 'N/A';
            }
        };

        // ============================================
        // MELHORIA #2: Fun√ß√£o global para formatar servi√ßos com detalhes
        // ============================================
        const getServicosDetalhados = (order) => {
            const servicos = [];
            
            if (order.oleoMotor) servicos.push(`√ìleo Motor (${order.oleoMarca || 'N/A'} - ${order.oleoQuantidade || 'N/A'}L)`);
            if (order.filtroOleo) servicos.push(`Filtro √ìleo (${order.filtroOleoTipo || 'N/A'})`);
            if (order.arMotor) servicos.push(`Filtro Ar Motor (${order.arMotorCodigo || 'N/A'})`);
            if (order.arCondicionado) servicos.push(`Filtro Ar Condicionado (${order.arCondicionadoCodigo || 'N/A'})`);
            if (order.filtroCombustivel) servicos.push(`Filtro Combust√≠vel (${order.filtroCombustivelCodigo || 'N/A'})`);
            if (order.cambioManual) servicos.push(`C√¢mbio Manual (${order.cambioManualMarca || 'N/A'} - ${order.cambioManualQuantidade || 'N/A'}L)`);
            
            // MELHORIA #2: C√¢mbio autom√°tico com detalhes completos
            if (order.cambioAutomatico) {
                const marca = order.cambioAutomaticoMarca || 'N/A';
                const qtdOleo = parseFloat(order.cambioAutomaticoQuantidade || 0);
                const qtdCarter = parseFloat(order.cambioAutomaticoFluidoCarter || 0);
                const total = qtdOleo + qtdCarter;
                
                let texto = `C√¢mbio Autom√°tico (${marca}`;
                
                if (qtdCarter > 0) {
                    texto += ` - Carter: ${qtdCarter}L`;
                }
                if (total > 0) {
                    texto += ` - Total: ${total}L`;
                }
                texto += ')';
                
                servicos.push(texto);
            }
            
            if (order.palhetas) servicos.push(`Palhetas (${order.palhetasCodigo || 'N/A'})`);
            if (order.militec) servicos.push('Militec/Nano');
            if (order.aditivo) servicos.push(`Aditivo (${order.aditivoQual || 'N/A'})`);
            if (order.flush) servicos.push('Flush');
            
            return servicos;
        };

        // ============================================
        // FUN√á√ïES AUXILIARES - BUSCA DE CLIENTES
        // ============================================
        
        // Buscar hist√≥rico completo de um cliente
        const buscarHistoricoCliente = async (termo) => {
            try {
                const snapshot = await db.collection('orders')
                    .where('status', '==', 'concluido')
                    .get();
                
                const ordens = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Filtrar por placa, nome ou telefone
                const termoLower = termo.toLowerCase();
                const resultado = ordens.filter(ordem => {
                    const placa = (ordem.placa || '').toLowerCase();
                    const cliente = (ordem.cliente || '').toLowerCase();
                    const tel = (ordem.tel || '').toLowerCase();
                    
                    return placa.includes(termoLower) || 
                           cliente.includes(termoLower) || 
                           tel.includes(termoLower);
                });
                
                // Agrupar por cliente/placa
                const clientesMap = {};
                resultado.forEach(ordem => {
                    const key = ordem.placa || ordem.cliente;
                    if (!clientesMap[key]) {
                        clientesMap[key] = {
                            placa: ordem.placa,
                            cliente: ordem.cliente,
                            tel: ordem.tel,
                            marca: ordem.marca,
                            modelo: ordem.modelo,
                            motor: ordem.motor,
                            ano: ordem.ano,
                            visitas: [],
                            totalGasto: 0,
                            upsellsAceitos: 0
                        };
                    }
                    
                    clientesMap[key].visitas.push(ordem);
                    clientesMap[key].totalGasto += parseFloat(ordem.valorTotal || 0);
                    if (ordem.fezUpsell) clientesMap[key].upsellsAceitos++;
                });
                
                return Object.values(clientesMap);
            } catch (error) {
                console.error('Erro ao buscar hist√≥rico:', error);
                return [];
            }
        };

        // ============================================
        // FUN√á√ïES AUXILIARES - SISTEMA DE ALERTAS
        // ============================================
        
        // Calcular alertas para todos os t√©cnicos
        const calcularAlertas = async (orders) => {
            const alertas = [];
            const tecnicos = Object.keys(SYSTEM_CONFIG.METAS);
            
            // USAR M√äS VIGENTE CONFIGURADO (n√£o mais m√™s atual autom√°tico)
            const mesVigente = SYSTEM_CONFIG.MES_VIGENTE.mes; // 1-12
            const anoVigente = SYSTEM_CONFIG.MES_VIGENTE.ano;
            
            // Calcular primeiro e √∫ltimo dia do m√™s vigente
            const inicioMes = new Date(anoVigente, mesVigente - 1, 1, 0, 0, 0);
            const fimMes = new Date(anoVigente, mesVigente, 0, 23, 59, 59);
            
            console.log(`üìä Calculando alertas para: ${getNomeMes(mesVigente)}/${anoVigente}`);
            console.log(`   Per√≠odo: ${inicioMes.toLocaleDateString('pt-BR')} a ${fimMes.toLocaleDateString('pt-BR')}`);
            
            const ordensDoMes = orders.filter(o => {
                if (!o.fim && !o.dataHora) return false;
                const dataOrdem = new Date(o.fim || o.dataHora);
                return dataOrdem >= inicioMes && dataOrdem <= fimMes;
            });
            
            console.log(`   Ordens no per√≠odo: ${ordensDoMes.length}`);
            
            for (const tecnico of tecnicos) {
                const ordensDoTecnico = ordensDoMes.filter(o => 
                    o.lubrificador === tecnico && o.status === 'concluido'
                );
                
                if (ordensDoTecnico.length === 0) continue;
                
                const metas = SYSTEM_CONFIG.METAS[tecnico];
                
                // Calcular m√©tricas
                const totalOrdens = ordensDoTecnico.length;
                const clientesAptos = ordensDoTecnico.filter(o => o.apto === 'sim').length;
                const aptosRecebeuOferta = ordensDoTecnico.filter(o => o.clienteAptoRecebeuOferta).length;
                const ordensComUpsell = ordensDoTecnico.filter(o => o.fezUpsell).length;
                
                const taxaOfertas = clientesAptos > 0 ? (aptosRecebeuOferta / clientesAptos) * 100 : 0;
                const taxaUpsell = (ordensComUpsell / totalOrdens) * 100;
                
                // Nome do m√™s para exibi√ß√£o
                const nomeMes = getNomeMes(mesVigente);
                
                // Gerar alertas baseado nas metas
                if (taxaOfertas < metas.ofertas) {
                    alertas.push({
                        tipo: 'warning',
                        tecnico: tecnico,
                        mensagem: `Taxa de ofertas ${taxaOfertas.toFixed(1)}% (Meta: ${metas.ofertas}%) - ${nomeMes}/${anoVigente}`,
                        detalhes: `${aptosRecebeuOferta}/${clientesAptos} clientes aptos receberam ofertas`
                    });
                }
                
                if (taxaUpsell < metas.upsell) {
                    alertas.push({
                        tipo: 'warning',
                        tecnico: tecnico,
                        mensagem: `Taxa de upsell ${taxaUpsell.toFixed(1)}% (Meta: ${metas.upsell}%) - ${nomeMes}/${anoVigente}`,
                        detalhes: `${ordensComUpsell}/${totalOrdens} ordens com upsell`
                    });
                }
                
                // Alerta cr√≠tico: sequ√™ncia sem ofertas (√∫ltimas 10 do m√™s vigente)
                const ultimas10 = ordensDoTecnico.slice(-10);
                const aptosUltimas10 = ultimas10.filter(o => o.apto === 'sim');
                const semOfertaUltimas10 = aptosUltimas10.filter(o => !o.clienteAptoRecebeuOferta);
                
                if (semOfertaUltimas10.length >= 3) {
                    alertas.push({
                        tipo: 'critical',
                        tecnico: tecnico,
                        mensagem: `üö® CR√çTICO: ${semOfertaUltimas10.length} clientes aptos sem oferta nas √∫ltimas 10 ordens!`,
                        detalhes: `Ordens: ${semOfertaUltimas10.map(o => '#' + o.numeroOrdem).join(', ')} (${nomeMes}/${anoVigente})`
                    });
                }
                
                // Alerta positivo
                if (taxaOfertas >= metas.ofertas && taxaUpsell >= metas.upsell) {
                    alertas.push({
                        tipo: 'success',
                        tecnico: tecnico,
                        mensagem: `üéâ Parab√©ns! Todas as metas atingidas!`,
                        detalhes: `Ofertas: ${taxaOfertas.toFixed(1)}% | Upsell: ${taxaUpsell.toFixed(1)}%`
                    });
                }
            }
            
            return alertas;
        };

        // Componente principal
        function App() {
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showNewOrderModal, setShowNewOrderModal] = useState(false);
            const [showExecuteModal, setShowExecuteModal] = useState(false);
            const [showDetailsModal, setShowDetailsModal] = useState(false);
            const [showEditModal, setShowEditModal] = useState(false);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [filterDate, setFilterDate] = useState('today');
            const [customDateStart, setCustomDateStart] = useState('');
            const [customDateEnd, setCustomDateEnd] = useState('');
            
            // NOVOS ESTADOS v3.0
            const [showConfigModal, setShowConfigModal] = useState(false);
            const [showSearchModal, setShowSearchModal] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [alertas, setAlertas] = useState([]);
            const [showAlertas, setShowAlertas] = useState(true);

            // Carregar ordens do Firebase
            const loadOrders = async () => {
                try {
                    setLoading(true);
                    const snapshot = await db.collection('orders').orderBy('numeroOrdem', 'desc').get();
                    const ordersData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setOrders(ordersData);
                    
                    // Calcular alertas automaticamente
                    if (SYSTEM_CONFIG.ALERTAS_ENABLED) {
                        const alertasCalculados = await calcularAlertas(ordersData);
                        setAlertas(alertasCalculados);
                    }
                } catch (error) {
                    console.error('Erro ao carregar ordens:', error);
                    alert('Erro ao carregar ordens. Verifique o console.');
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                loadOrders();
                const interval = setInterval(loadOrders, 30000); // Auto-refresh a cada 30s
                return () => clearInterval(interval);
            }, []);

            // Filtrar ordens por data
            const getFilteredOrders = () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                return orders.filter(order => {
                    if (!order.dataHora) return false;

                    const orderDate = new Date(order.dataHora);
                    orderDate.setHours(0, 0, 0, 0);

                    switch (filterDate) {
                        case 'today':
                            return orderDate.getTime() === today.getTime();
                        case 'week':
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            return orderDate >= weekAgo;
                        case 'month':
                            const monthAgo = new Date(today);
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            return orderDate >= monthAgo;
                        case 'custom':
                            if (!customDateStart || !customDateEnd) return true;
                            const start = new Date(customDateStart);
                            const end = new Date(customDateEnd);
                            return orderDate >= start && orderDate <= end;
                        default:
                            return true;
                    }
                });
            };

            const filteredOrders = getFilteredOrders();
            const aguardando = filteredOrders.filter(o => o.status === 'aguardando');
            const emAndamento = filteredOrders.filter(o => o.status === 'andamento');
            const concluidos = filteredOrders.filter(o => o.status === 'concluido');

            // Calcular pr√≥ximo n√∫mero de ordem
            const getNextOrderNumber = () => {
                if (orders.length === 0) return 1;
                const maxNumber = Math.max(...orders.map(o => o.numeroOrdem || 0));
                return maxNumber + 1;
            };

            // Fun√ß√£o para cancelar ordem
            const cancelarOrdem = async (orderId) => {
                if (confirm('Tem certeza que deseja cancelar esta ordem?')) {
                    try {
                        await db.collection('orders').doc(orderId).delete();
                        alert('Ordem cancelada com sucesso!');
                        loadOrders();
                    } catch (error) {
                        console.error('Erro ao cancelar ordem:', error);
                        alert('Erro ao cancelar ordem.');
                    }
                }
            };

            // Fun√ß√£o para iniciar atendimento (muda status para andamento)
            const handleIniciarAtendimento = async (order) => {
                try {
                    await db.collection('orders').doc(order.id).update({
                        status: 'andamento',
                        inicio: getBrasilDateTime()
                    });
                    
                    // Sincronizar com Google Sheets
                    await syncToSheets('update', { ...order, status: 'andamento', inicio: getBrasilDateTime() });
                    
                    alert('Atendimento iniciado! Carro movido para "Em Andamento".');
                    loadOrders();
                } catch (error) {
                    console.error('Erro ao iniciar atendimento:', error);
                    alert('Erro ao iniciar atendimento.');
                }
            };

            return (
                <div className="container">
                    <div className="header">
                        <div className="logo">
                            üöó Master √ìleo Curitiba
                        </div>
                        <div className="stats">
                            <div className="stat">
                                <div className="stat-number">{aguardando.length}</div>
                                <div className="stat-label">Aguardando</div>
                            </div>
                            <div className="stat">
                                <div className="stat-number">{emAndamento.length}</div>
                                <div className="stat-label">Em Andamento</div>
                            </div>
                            <div className="stat">
                                <div className="stat-number">{concluidos.length}</div>
                                <div className="stat-label">Conclu√≠dos</div>
                            </div>
                            <div className="stat">
                                <div className="stat-number">{filteredOrders.length}</div>
                                <div className="stat-label">Total</div>
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                            <button className="btn btn-primary" onClick={() => setShowNewOrderModal(true)}>
                                ‚ûï Nova Ordem
                            </button>
                            <button className="btn btn-secondary" onClick={() => setShowSearchModal(true)}>
                                üîç Buscar Cliente
                            </button>
                            <button className="btn btn-secondary" onClick={() => setShowConfigModal(true)}>
                                ‚öôÔ∏è Configura√ß√µes
                            </button>
                            <button className="btn btn-secondary" onClick={loadOrders}>
                                üîÑ Atualizar
                            </button>
                        </div>
                    </div>
                    
                    {/* BANNER DE ALERTAS */}
                    {SYSTEM_CONFIG.ALERTAS_ENABLED && alertas.length > 0 && showAlertas && (
                        <div style={{
                            background: '#fff3cd',
                            border: '2px solid #ffc107',
                            borderRadius: '10px',
                            padding: '15px',
                            marginBottom: '20px'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>
                                <div>
                                    <h3 style={{ margin: 0, color: '#856404' }}>‚ö†Ô∏è ALERTAS DE PERFORMANCE</h3>
                                    <div style={{ fontSize: '12px', color: '#856404', marginTop: '4px' }}>
                                        üìÖ Per√≠odo de Avalia√ß√£o: <strong>{getNomeMes(SYSTEM_CONFIG.MES_VIGENTE.mes)}/{SYSTEM_CONFIG.MES_VIGENTE.ano}</strong>
                                    </div>
                                </div>
                                <button 
                                    onClick={() => setShowAlertas(false)}
                                    style={{
                                        background: 'transparent',
                                        border: 'none',
                                        fontSize: '20px',
                                        cursor: 'pointer',
                                        color: '#856404'
                                    }}
                                >
                                    ‚úï
                                </button>
                            </div>
                            {alertas.map((alerta, idx) => (
                                <div 
                                    key={idx}
                                    style={{
                                        padding: '10px',
                                        marginBottom: '8px',
                                        borderRadius: '5px',
                                        background: alerta.tipo === 'critical' ? '#fee2e2' : 
                                                   alerta.tipo === 'warning' ? '#fef3c7' : '#d1fae5',
                                        color: alerta.tipo === 'critical' ? '#991b1b' : 
                                               alerta.tipo === 'warning' ? '#92400e' : '#065f46'
                                    }}
                                >
                                    <div style={{ fontWeight: 'bold' }}>
                                        {alerta.tipo === 'critical' ? 'üî¥' : alerta.tipo === 'warning' ? 'üü°' : 'üü¢'} 
                                        {' '}{alerta.tecnico}: {alerta.mensagem}
                                    </div>
                                    <div style={{ fontSize: '12px', marginTop: '4px' }}>
                                        {alerta.detalhes}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    <div className="filters">
                        <span style={{ fontWeight: 'bold', color: '#2d3748' }}>Filtrar por:</span>
                        <button 
                            className={`filter-btn ${filterDate === 'today' ? 'active' : ''}`}
                            onClick={() => setFilterDate('today')}
                        >
                            Hoje
                        </button>
                        <button 
                            className={`filter-btn ${filterDate === 'week' ? 'active' : ''}`}
                            onClick={() => setFilterDate('week')}
                        >
                            √öltima Semana
                        </button>
                        <button 
                            className={`filter-btn ${filterDate === 'month' ? 'active' : ''}`}
                            onClick={() => setFilterDate('month')}
                        >
                            √öltimo M√™s
                        </button>
                        <button 
                            className={`filter-btn ${filterDate === 'all' ? 'active' : ''}`}
                            onClick={() => setFilterDate('all')}
                        >
                            Todos
                        </button>
                    </div>

                    {loading ? (
                        <div className="loading">
                            <div className="spinner"></div>
                        </div>
                    ) : (
                        <>
                            {aguardando.length > 0 && (
                                <>
                                    <h2 style={{ color: 'white', marginBottom: '15px', fontSize: '22px' }}>
                                        üü° Aguardando Atendimento ({aguardando.length})
                                    </h2>
                                    <div className="cards-container">
                                        {aguardando.map((order, index) => (
                                            <CardAguardando 
                                                key={order.id} 
                                                order={order} 
                                                position={index + 1}
                                                onIniciar={() => handleIniciarAtendimento(order)}
                                                onCancelar={() => cancelarOrdem(order.id)}
                                                onVerDados={() => {
                                                    setSelectedOrder(order);
                                                    setShowDetailsModal(true);
                                                }}
                                                onEditar={() => {
                                                    setSelectedOrder(order);
                                                    setShowEditModal(true);
                                                }}
                                            />
                                        ))}
                                    </div>
                                </>
                            )}

                            {emAndamento.length > 0 && (
                                <>
                                    <h2 style={{ color: 'white', marginBottom: '15px', marginTop: '30px', fontSize: '22px' }}>
                                        üîµ Em Andamento ({emAndamento.length})
                                    </h2>
                                    <div className="cards-container">
                                        {emAndamento.map(order => (
                                            <CardEmAndamento 
                                                key={order.id} 
                                                order={order}
                                                onVerDados={() => {
                                                    setSelectedOrder(order);
                                                    setShowDetailsModal(true);
                                                }}
                                                onEditar={() => {
                                                    setSelectedOrder(order);
                                                    setShowEditModal(true);
                                                }}
                                                onFinalizar={() => {
                                                    setSelectedOrder(order);
                                                    setShowExecuteModal(true);
                                                }}
                                            />
                                        ))}
                                    </div>
                                </>
                            )}

                            {concluidos.length > 0 && (
                                <>
                                    <h2 style={{ color: 'white', marginBottom: '15px', marginTop: '30px', fontSize: '22px' }}>
                                        üü¢ Conclu√≠dos ({concluidos.length})
                                    </h2>
                                    <div className="cards-container">
                                        {concluidos.map(order => (
                                            <CardConcluido 
                                                key={order.id} 
                                                order={order}
                                                onVer={() => {
                                                    setSelectedOrder(order);
                                                    setShowDetailsModal(true);
                                                }}
                                            />
                                        ))}
                                    </div>
                                </>
                            )}

                            {filteredOrders.length === 0 && (
                                <div className="empty-state">
                                    <div className="empty-state-icon">üìã</div>
                                    <h3>Nenhuma ordem encontrada</h3>
                                    <p>Comece criando uma nova ordem</p>
                                </div>
                            )}
                        </>
                    )}

                    {showNewOrderModal && (
                        <NovaOrdemModal 
                            onClose={() => setShowNewOrderModal(false)}
                            onSuccess={() => {
                                setShowNewOrderModal(false);
                                loadOrders();
                            }}
                            nextOrderNumber={getNextOrderNumber()}
                        />
                    )}

                    {showExecuteModal && selectedOrder && (
                        <ExecutarServicoModal 
                            order={selectedOrder}
                            onClose={() => {
                                setShowExecuteModal(false);
                                setSelectedOrder(null);
                            }}
                            onSuccess={() => {
                                setShowExecuteModal(false);
                                setSelectedOrder(null);
                                loadOrders();
                            }}
                        />
                    )}

                    {showDetailsModal && selectedOrder && (
                        <DetalhesModal 
                            order={selectedOrder}
                            onClose={() => {
                                setShowDetailsModal(false);
                                setSelectedOrder(null);
                            }}
                            onUpdate={loadOrders}
                        />
                    )}

                    {showEditModal && selectedOrder && (
                        <EditarOrdemModal 
                            order={selectedOrder}
                            onClose={() => {
                                setShowEditModal(false);
                                setSelectedOrder(null);
                            }}
                            onUpdate={loadOrders}
                        />
                    )}
                    
                    {/* MODAL BUSCA DE CLIENTES */}
                    {showSearchModal && (
                        <BuscarClienteModal 
                            onClose={() => setShowSearchModal(false)}
                            onSelectCliente={(cliente) => {
                                // Preencher nova ordem com dados do cliente
                                setShowSearchModal(false);
                                setShowNewOrderModal(true);
                                // TODO: Passar dados do cliente para NovaOrdemModal
                            }}
                        />
                    )}
                    
                    {/* MODAL CONFIGURA√á√ïES */}
                    {showConfigModal && (
                        <ConfiguracoesModal 
                            onClose={() => setShowConfigModal(false)}
                            onSave={() => {
                                setShowConfigModal(false);
                                loadOrders(); // Recarregar para recalcular alertas
                            }}
                        />
                    )}
                </div>
            );
        }

        // Componente Card Aguardando
        function CardAguardando({ order, position, onIniciar, onCancelar, onVerDados, onEditar }) {
            const servicos = getServicosDetalhados(order);

            return (
                <div className="card card-aguardando">
                    <div className="card-header">
                        <span className="order-number">#{order.numeroOrdem}</span>
                        <span className="queue-position">Posi√ß√£o {position}</span>
                        <button className="close-btn" onClick={onCancelar} style={{ color: '#f56565' }}>‚úï</button>
                    </div>
                    <div className="card-title">{order.placa}</div>
                    <div className="card-info">
                        <div className="info-row">
                            <span className="info-label">Cliente:</span>
                            <span>{order.cliente}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Ve√≠culo:</span>
                            <span>{order.marca} {order.modelo}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Motor:</span>
                            <span>{order.motor || 'N/A'}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Vendedor:</span>
                            <span>{order.vendedor}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Registro:</span>
                            <span>{order.dataHora ? new Date(order.dataHora).toLocaleString('pt-BR') : 'N/A'}</span>
                        </div>
                    </div>
                    {servicos.length > 0 && (
                        <div className="services-list">
                            <div style={{ fontWeight: 'bold', marginBottom: '8px', color: '#2d3748' }}>Servi√ßos:</div>
                            {servicos.map((s, i) => (
                                <div key={i} className="service-item">‚Ä¢ {s}</div>
                            ))}
                        </div>
                    )}
                    <div className="card-actions">
                        <button className="btn btn-secondary" onClick={onVerDados} style={{ flex: 1 }}>
                            üìã Ver Dados
                        </button>
                        <button className="btn btn-secondary" onClick={onEditar} style={{ flex: 1 }}>
                            ‚úèÔ∏è Editar
                        </button>
                        <button className="btn btn-success" onClick={onIniciar} style={{ flex: 1 }}>
                            ‚ñ∂Ô∏è Iniciar
                        </button>
                    </div>
                </div>
            );
        }

        // Componente Card Em Andamento
        function CardEmAndamento({ order, onVerDados, onEditar, onFinalizar }) {
            const servicos = getServicosDetalhados(order);

            return (
                <div className="card" style={{ borderLeft: '5px solid #4299e1', background: 'linear-gradient(135deg, #e6f2ff 0%, #ffffff 100%)' }}>
                    <div className="card-header">
                        <span className="order-number">#{order.numeroOrdem}</span>
                        <span className="badge" style={{ background: '#4299e1', color: 'white' }}>üîµ Em Atendimento</span>
                    </div>
                    <div className="card-title">{order.placa}</div>
                    <div className="card-info">
                        <div className="info-row">
                            <span className="info-label">Cliente:</span>
                            <span>{order.cliente}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Ve√≠culo:</span>
                            <span>{order.marca} {order.modelo}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Motor:</span>
                            <span>{order.motor || 'N/A'}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Lubrificador:</span>
                            <span style={{ fontWeight: 'bold', color: '#4299e1' }}>{order.lubrificador}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">In√≠cio:</span>
                            <span>{order.inicio || 'N/A'}</span>
                        </div>
                    </div>
                    {servicos.length > 0 && (
                        <div className="services-list">
                            <div style={{ fontWeight: 'bold', marginBottom: '8px', color: '#2d3748' }}>Servi√ßos:</div>
                            {servicos.map((s, i) => (
                                <div key={i} className="service-item">‚Ä¢ {s}</div>
                            ))}
                        </div>
                    )}
                    <div className="card-actions">
                        <button className="btn btn-secondary" onClick={onVerDados} style={{ flex: 1 }}>
                            üìã Ver Dados
                        </button>
                        <button className="btn btn-secondary" onClick={onEditar} style={{ flex: 1 }}>
                            ‚úèÔ∏è Editar
                        </button>
                        <button className="btn btn-success" onClick={onFinalizar} style={{ flex: 1 }}>
                            ‚úÖ Finalizar
                        </button>
                    </div>
                </div>
            );
        }

        // Componente Card Conclu√≠do
        function CardConcluido({ order, onVer }) {
            return (
                <div className="card card-concluido">
                    <div className="card-header">
                        <span className="order-number">#{order.numeroOrdem}</span>
                        {order.fezUpsell && (
                            <span className="badge badge-upsell">üí∞ Upsell +R$ {order.valorUpsell?.toFixed(2)}</span>
                        )}
                        {order.voltouComProblema && (
                            <span className="badge badge-problem">‚ö†Ô∏è Retornou</span>
                        )}
                    </div>
                    <div className="card-title">{order.placa}</div>
                    <div className="card-info">
                        <div className="info-row">
                            <span className="info-label">Cliente:</span>
                            <span>{order.cliente}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Ve√≠culo:</span>
                            <span>{order.marca} {order.modelo}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Motor:</span>
                            <span>{order.motor || 'N/A'}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Lubrificador:</span>
                            <span>{order.lubrificador}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Registro:</span>
                            <span>{order.dataHora ? new Date(order.dataHora).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }) : 'N/A'}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">In√≠cio:</span>
                            <span>{order.inicio || 'N/A'}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Fim:</span>
                            <span>{order.fim || 'N/A'}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Valor Inicial:</span>
                            <span>R$ {parseFloat(order.valorInicial || 0).toFixed(2)}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Valor Total:</span>
                            <span style={{ fontWeight: 'bold', color: '#667eea' }}>R$ {parseFloat(order.valorTotal || 0).toFixed(2)}</span>
                        </div>
                    </div>
                    <div className="card-actions">
                        <button className="btn btn-primary" onClick={onVer} style={{ flex: 1 }}>
                            üëÅÔ∏è Ver Detalhes
                        </button>
                    </div>
                </div>
            );
        }

        // Modal Nova Ordem
        function NovaOrdemModal({ onClose, onSuccess, nextOrderNumber }) {
            const [step, setStep] = useState(1);
            
            // NOVO: Estados para busca r√°pida
            const [buscaRapida, setBuscaRapida] = useState('');
            const [resultadosBusca, setResultadosBusca] = useState([]);
            const [buscando, setBuscando] = useState(false);
            const [mostrarBusca, setMostrarBusca] = useState(false);
            
            // Carregar dados salvos do localStorage
            const [customMarcas, setCustomMarcas] = useState(() => {
                const saved = localStorage.getItem('customMarcas');
                return saved ? JSON.parse(saved) : [];
            });
            const [customModelos, setCustomModelos] = useState(() => {
                const saved = localStorage.getItem('customModelos');
                return saved ? JSON.parse(saved) : {};
            });
            const [customMotores, setCustomMotores] = useState(() => {
                const saved = localStorage.getItem('customMotores');
                return saved ? JSON.parse(saved) : [];
            });

            // Marcas principais
            const marcasPrincipais = [
                'Chevrolet', 'Volkswagen', 'Fiat', 'Ford', 'Toyota', 'Honda', 'Hyundai',
                'Nissan', 'Renault', 'Jeep', 'Peugeot', 'Citro√´n', 'BMW', 'Mercedes-Benz',
                'Audi', 'Volvo', 'Mitsubishi', 'Kia', 'Chery', 'JAC'
            ];

            // Modelos por marca (principais)
            const modelosPorMarca = {
                'Chevrolet': ['Onix', 'Prisma', 'Cruze', 'Tracker', 'S10', 'Montana', 'Spin', 'Cobalt'],
                'Volkswagen': ['Gol', 'Voyage', 'Polo', 'Virtus', 'T-Cross', 'Nivus', 'Tiguan', 'Amarok'],
                'Fiat': ['Uno', 'Argo', 'Mobi', 'Toro', 'Strada', 'Cronos', 'Pulse', 'Fastback'],
                'Ford': ['Ka', 'Fiesta', 'EcoSport', 'Ranger', 'Focus', 'Fusion'],
                'Toyota': ['Corolla', 'Hilux', 'Etios', 'Yaris', 'SW4', 'RAV4'],
                'Honda': ['Civic', 'City', 'HR-V', 'CR-V', 'Fit', 'WR-V'],
                'Hyundai': ['HB20', 'Creta', 'Tucson', 'ix35', 'Elantra', 'Santa Fe'],
                'Nissan': ['Kicks', 'Versa', 'Frontier', 'Sentra', 'March'],
                'Renault': ['Kwid', 'Sandero', 'Logan', 'Duster', 'Captur', 'Oroch'],
                'Jeep': ['Renegade', 'Compass', 'Commander', 'Wrangler']
            };

            // Motores principais
            const motoresPrincipais = [
                '1.0', '1.0 Turbo', '1.2', '1.3', '1.4', '1.5', '1.6', '1.8', '2.0',
                '2.0 Turbo', '2.2', '2.4', '2.5', '3.0', '3.6', '4.0', '5.0'
            ];

            // Combinar listas (principais + customizadas)
            const todasMarcas = [...new Set([...marcasPrincipais, ...customMarcas])].sort();
            const todosMotores = [...new Set([...motoresPrincipais, ...customMotores])].sort();
            
            const getModelosPorMarca = (marca) => {
                const principais = modelosPorMarca[marca] || [];
                const customizados = customModelos[marca] || [];
                return [...new Set([...principais, ...customizados])].sort();
            };

            // Estados para adicionar novos itens
            const [showAddMarca, setShowAddMarca] = useState(false);
            const [showAddModelo, setShowAddModelo] = useState(false);
            const [showAddMotor, setShowAddMotor] = useState(false);
            const [novaMarca, setNovaMarca] = useState('');
            const [novoModelo, setNovoModelo] = useState('');
            const [novoMotor, setNovoMotor] = useState('');

            const adicionarMarca = () => {
                if (novaMarca.trim() && !todasMarcas.includes(novaMarca.trim())) {
                    const updated = [...customMarcas, novaMarca.trim()];
                    setCustomMarcas(updated);
                    localStorage.setItem('customMarcas', JSON.stringify(updated));
                    setFormData(prev => ({ ...prev, marca: novaMarca.trim() }));
                    setNovaMarca('');
                    setShowAddMarca(false);
                }
            };

            const adicionarModelo = () => {
                if (novoModelo.trim() && formData.marca) {
                    const updated = {
                        ...customModelos,
                        [formData.marca]: [...(customModelos[formData.marca] || []), novoModelo.trim()]
                    };
                    setCustomModelos(updated);
                    localStorage.setItem('customModelos', JSON.stringify(updated));
                    setFormData(prev => ({ ...prev, modelo: novoModelo.trim() }));
                    setNovoModelo('');
                    setShowAddModelo(false);
                }
            };

            const adicionarMotor = () => {
                if (novoMotor.trim() && !todosMotores.includes(novoMotor.trim())) {
                    const updated = [...customMotores, novoMotor.trim()];
                    setCustomMotores(updated);
                    localStorage.setItem('customMotores', JSON.stringify(updated));
                    setFormData(prev => ({ ...prev, motor: novoMotor.trim() }));
                    setNovoMotor('');
                    setShowAddMotor(false);
                }
            };

            const [formData, setFormData] = useState({
                numeroOrdem: nextOrderNumber,
                status: 'aguardando',
                vendedor: '',
                cliente: '',
                tel: '',
                cpf: '',
                dataNascimento: '',
                placa: '',
                marca: '',
                modelo: '',
                motor: '',
                ano: '',
                cambio: '',
                combustivel: '',
                dataHora: formatDateTimeForInput(),
                oleoMotor: false,
                oleoMarca: '',
                oleoQuantidade: '',
                filtroOleo: false,
                filtroOleoTipo: '',
                arMotor: false,
                arMotorCodigo: '',
                arCondicionado: false,
                arCondicionadoCodigo: '',
                filtroCombustivel: false,
                filtroCombustivelCodigo: '',
                cambioManual: false,
                cambioManualMarca: '',
                cambioManualQuantidade: '',
                cambioAutomatico: false,
                cambioAutomaticoMarca: '',
                cambioAutomaticoQuantidade: '',
                cambioAutomaticoTemFiltro: false,
                cambioAutomaticoFiltroCodigo: '',
                cambioAutomaticoFluidoCarter: '',
                palhetas: false,
                palhetasCodigo: '',
                militec: false,
                aditivo: false,
                aditivoQual: '',
                flush: false,
                flushDescricao: '',
                
                apto: 'sim',
                motivoNaoApto: '',
                valorInicial: ''
            });

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: type === 'checkbox' ? checked : value
                }));
            };

            const validateStep1 = () => {
                if (!formData.vendedor || !formData.cliente || !formData.placa) {
                    alert('Preencha os campos obrigat√≥rios: Vendedor, Cliente e Placa');
                    return false;
                }
                
                const placaRegex = /^[A-Z]{3}-?\d{4}$|^[A-Z]{3}\d[A-Z]\d{2}$/;
                if (!placaRegex.test(formData.placa.toUpperCase())) {
                    alert('Placa inv√°lida. Use formato AAA-1234 ou AAA1A23');
                    return false;
                }
                
                if (formData.tel && formData.tel.length < 10) {
                    alert('Telefone inv√°lido');
                    return false;
                }
                
                return true;
            };

            const validateStep2 = () => {
                const hasService = formData.oleoMotor || formData.filtroOleo || formData.arMotor || 
                                  formData.arCondicionado || formData.filtroCombustivel || 
                                  formData.cambioManual || formData.cambioAutomatico || 
                                  formData.palhetas || formData.militec || formData.aditivo || formData.flush;
                
                if (!hasService) {
                    alert('Selecione pelo menos um servi√ßo');
                    return false;
                }
                
                return true;
            };

            const validateStep3 = () => {
                if (!formData.valorInicial || parseFloat(formData.valorInicial) <= 0) {
                    alert('Preencha o valor inicial da venda');
                    return false;
                }
                
                if (formData.apto === 'nao' && !formData.motivoNaoApto) {
                    alert('Informe o motivo do cliente n√£o ser apto para ofertas');
                    return false;
                }
                
                return true;
            };

            const handleNext = () => {
                if (step === 1 && !validateStep1()) return;
                if (step === 2 && !validateStep2()) return;
                if (step < 3) setStep(step + 1);
            };

            const handleSubmit = async () => {
                if (!validateStep3()) return;
                
                try {
                    const orderData = {
                        ...formData,
                        dataHora: new Date(formData.dataHora).toISOString(),
                        placa: formData.placa.toUpperCase(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const docRef = await db.collection('orders').add(orderData);
                    
                    // Sincronizar com Google Sheets
                    await syncToSheets('create', { id: docRef.id, ...orderData });
                    
                    alert('Ordem criada com sucesso!');
                    onSuccess();
                } catch (error) {
                    console.error('Erro ao criar ordem:', error);
                    alert('Erro ao criar ordem. Tente novamente.');
                }
            };

            // MELHORIA #1: Busca r√°pida de cliente
            const handleBuscaRapida = async () => {
                if (buscaRapida.length < 3) {
                    alert('Digite pelo menos 3 caracteres');
                    return;
                }

                setBuscando(true);
                try {
                    const clientes = await buscarHistoricoCliente(buscaRapida);
                    setResultadosBusca(clientes);
                    setMostrarBusca(true);
                } catch (error) {
                    console.error('Erro na busca:', error);
                    alert('Erro ao buscar clientes');
                } finally {
                    setBuscando(false);
                }
            };

            // Preencher dados do cliente automaticamente
            const preencherDadosCliente = (cliente) => {
                setFormData(prev => ({
                    ...prev,
                    cliente: cliente.cliente || '',
                    tel: cliente.tel || '',
                    placa: cliente.placa || '',
                    marca: cliente.marca || '',
                    modelo: cliente.modelo || '',
                    motor: cliente.motor || '',
                    ano: cliente.ano || ''
                }));
                
                setMostrarBusca(false);
                setBuscaRapida('');
                setResultadosBusca([]);
                
                alert('‚úÖ Dados preenchidos! Continue com os servi√ßos.');
            };

            return (
                <div className="modal">
                    <div className="modal-content">
                        <div className="modal-header">
                            <div className="modal-title">Nova Ordem #{nextOrderNumber}</div>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>
                        
                        <div className="modal-body">
                            <div className="step-indicator">
                                <div className={`step ${step >= 1 ? 'active' : ''} ${step > 1 ? 'completed' : ''}`}>
                                    <div className="step-number">1</div>
                                    <div className="step-label">Cliente</div>
                                </div>
                                <div className={`step ${step >= 2 ? 'active' : ''} ${step > 2 ? 'completed' : ''}`}>
                                    <div className="step-number">2</div>
                                    <div className="step-label">Servi√ßos</div>
                                </div>
                                <div className={`step ${step >= 3 ? 'active' : ''}`}>
                                    <div className="step-number">3</div>
                                    <div className="step-label">Finaliza√ß√£o</div>
                                </div>
                            </div>

                            {step === 1 && (
                                <div>
                                    {/* MELHORIA #1: BUSCA R√ÅPIDA INTEGRADA */}
                                    <div style={{
                                        background: '#e6f2ff',
                                        border: '2px solid #3b82f6',
                                        borderRadius: '10px',
                                        padding: '20px',
                                        marginBottom: '25px'
                                    }}>
                                        <h4 style={{ marginBottom: '10px', color: '#1e40af' }}>
                                            üîç Cliente j√° Veio Antes? Busque Aqui!
                                        </h4>
                                        <p style={{ fontSize: '13px', color: '#64748b', marginBottom: '15px' }}>
                                            Digite placa, nome ou telefone para preencher dados automaticamente
                                        </p>
                                        <div style={{ display: 'flex', gap: '10px' }}>
                                            <input 
                                                type="text"
                                                value={buscaRapida}
                                                onChange={(e) => setBuscaRapida(e.target.value)}
                                                onKeyPress={(e) => e.key === 'Enter' && handleBuscaRapida()}
                                                placeholder="Ex: AKX1234 ou Jo√£o Silva ou 41999..."
                                                className="form-input"
                                                style={{ flex: 1 }}
                                            />
                                            <button 
                                                className="btn btn-primary"
                                                onClick={handleBuscaRapida}
                                                disabled={buscando}
                                                style={{ minWidth: '120px' }}
                                            >
                                                {buscando ? '‚è≥ Buscando...' : 'üîç Buscar'}
                                            </button>
                                        </div>

                                        {mostrarBusca && resultadosBusca.length > 0 && (
                                            <div style={{
                                                marginTop: '15px',
                                                maxHeight: '300px',
                                                overflowY: 'auto',
                                                background: 'white',
                                                borderRadius: '8px',
                                                padding: '10px'
                                            }}>
                                                <h5 style={{ marginBottom: '10px' }}>‚úÖ {resultadosBusca.length} resultado(s):</h5>
                                                {resultadosBusca.map((cliente, idx) => (
                                                    <div 
                                                        key={idx}
                                                        onClick={() => preencherDadosCliente(cliente)}
                                                        style={{
                                                            padding: '12px',
                                                            marginBottom: '8px',
                                                            background: '#f7fafc',
                                                            borderRadius: '6px',
                                                            cursor: 'pointer',
                                                            border: '1px solid #e2e8f0',
                                                            transition: 'all 0.2s'
                                                        }}
                                                        onMouseEnter={(e) => e.currentTarget.style.background = '#e6f2ff'}
                                                        onMouseLeave={(e) => e.currentTarget.style.background = '#f7fafc'}
                                                    >
                                                        <div style={{ fontWeight: 'bold', marginBottom: '4px' }}>
                                                            üöó {cliente.placa} - {cliente.cliente}
                                                        </div>
                                                        <div style={{ fontSize: '13px', color: '#64748b' }}>
                                                            {cliente.marca} {cliente.modelo} {cliente.motor} - {cliente.ano} | 
                                                            {' '}{cliente.visitas.length} visita(s) | 
                                                            {' '}Tel: {cliente.tel}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}

                                        {mostrarBusca && resultadosBusca.length === 0 && (
                                            <div style={{
                                                marginTop: '15px',
                                                padding: '15px',
                                                background: '#fef3c7',
                                                borderRadius: '8px',
                                                color: '#92400e',
                                                textAlign: 'center'
                                            }}>
                                                ‚ÑπÔ∏è Nenhum cliente encontrado. Preencha os dados manualmente abaixo.
                                            </div>
                                        )}
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label">Vendedor *</label>
                                        <select name="vendedor" value={formData.vendedor} onChange={handleChange} className="form-select" required>
                                            <option value="">Selecione...</option>
                                            <option value="Leo">Leo</option>
                                            <option value="Carlos">Carlos</option>
                                            <option value="Faust">Faust</option>
                                            <option value="Danilo">Danilo</option>
                                        </select>
                                    </div>

                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Nome do Cliente *</label>
                                            <input type="text" name="cliente" value={formData.cliente} onChange={handleChange} className="form-input" required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Data/Hora</label>
                                            <input type="datetime-local" name="dataHora" value={formData.dataHora} onChange={handleChange} className="form-input" />
                                        </div>
                                    </div>

                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Telefone</label>
                                            <input type="tel" name="tel" value={formData.tel} onChange={handleChange} className="form-input" placeholder="(00) 00000-0000" />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">CPF/CNPJ</label>
                                            <input type="text" name="cpf" value={formData.cpf} onChange={handleChange} className="form-input" placeholder="000.000.000-00" />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Data de Nascimento</label>
                                            <input type="date" name="dataNascimento" value={formData.dataNascimento} onChange={handleChange} className="form-input" />
                                        </div>
                                    </div>

                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Placa *</label>
                                            <input type="text" name="placa" value={formData.placa} onChange={handleChange} className="form-input" placeholder="ABC-1234 ou ABC1D23" maxLength="8" required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Ano</label>
                                            <input type="number" name="ano" value={formData.ano} onChange={handleChange} className="form-input" placeholder="2024" />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">C√¢mbio</label>
                                            <select name="cambio" value={formData.cambio} onChange={handleChange} className="form-select">
                                                <option value="">Selecione...</option>
                                                <option value="Manual">Manual</option>
                                                <option value="Autom√°tico">Autom√°tico</option>
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Combust√≠vel</label>
                                            <select name="combustivel" value={formData.combustivel} onChange={handleChange} className="form-select">
                                                <option value="">Selecione...</option>
                                                <option value="Gasolina">Gasolina</option>
                                                <option value="Diesel">Diesel</option>
                                                <option value="Flex">Flex</option>
                                                <option value="GNV">GNV</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Marca</label>
                                            {!showAddMarca ? (
                                                <div style={{ display: 'flex', gap: '10px' }}>
                                                    <select 
                                                        name="marca" 
                                                        value={formData.marca} 
                                                        onChange={(e) => {
                                                            handleChange(e);
                                                            // Limpar modelo quando trocar marca
                                                            setFormData(prev => ({ ...prev, modelo: '' }));
                                                        }} 
                                                        className="form-select"
                                                        style={{ flex: 1 }}
                                                    >
                                                        <option value="">Selecione...</option>
                                                        {todasMarcas.map(m => (
                                                            <option key={m} value={m}>{m}</option>
                                                        ))}
                                                    </select>
                                                    <button 
                                                        type="button"
                                                        className="btn btn-secondary" 
                                                        onClick={() => setShowAddMarca(true)}
                                                        style={{ padding: '8px 16px' }}
                                                    >
                                                        +
                                                    </button>
                                                </div>
                                            ) : (
                                                <div style={{ display: 'flex', gap: '10px' }}>
                                                    <input 
                                                        type="text"
                                                        className="form-input"
                                                        placeholder="Nova marca..."
                                                        value={novaMarca}
                                                        onChange={(e) => setNovaMarca(e.target.value)}
                                                        style={{ flex: 1 }}
                                                    />
                                                    <button 
                                                        type="button"
                                                        className="btn btn-success" 
                                                        onClick={adicionarMarca}
                                                        style={{ padding: '8px 16px' }}
                                                    >
                                                        ‚úì
                                                    </button>
                                                    <button 
                                                        type="button"
                                                        className="btn btn-danger" 
                                                        onClick={() => {
                                                            setShowAddMarca(false);
                                                            setNovaMarca('');
                                                        }}
                                                        style={{ padding: '8px 16px' }}
                                                    >
                                                        ‚úï
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Modelo</label>
                                            {!showAddModelo ? (
                                                <div style={{ display: 'flex', gap: '10px' }}>
                                                    <select 
                                                        name="modelo" 
                                                        value={formData.modelo} 
                                                        onChange={handleChange} 
                                                        className="form-select"
                                                        style={{ flex: 1 }}
                                                        disabled={!formData.marca}
                                                    >
                                                        <option value="">Selecione...</option>
                                                        {formData.marca && getModelosPorMarca(formData.marca).map(m => (
                                                            <option key={m} value={m}>{m}</option>
                                                        ))}
                                                    </select>
                                                    <button 
                                                        type="button"
                                                        className="btn btn-secondary" 
                                                        onClick={() => setShowAddModelo(true)}
                                                        disabled={!formData.marca}
                                                        style={{ padding: '8px 16px' }}
                                                    >
                                                        +
                                                    </button>
                                                </div>
                                            ) : (
                                                <div style={{ display: 'flex', gap: '10px' }}>
                                                    <input 
                                                        type="text"
                                                        className="form-input"
                                                        placeholder="Novo modelo..."
                                                        value={novoModelo}
                                                        onChange={(e) => setNovoModelo(e.target.value)}
                                                        style={{ flex: 1 }}
                                                    />
                                                    <button 
                                                        type="button"
                                                        className="btn btn-success" 
                                                        onClick={adicionarModelo}
                                                        style={{ padding: '8px 16px' }}
                                                    >
                                                        ‚úì
                                                    </button>
                                                    <button 
                                                        type="button"
                                                        className="btn btn-danger" 
                                                        onClick={() => {
                                                            setShowAddModelo(false);
                                                            setNovoModelo('');
                                                        }}
                                                        style={{ padding: '8px 16px' }}
                                                    >
                                                        ‚úï
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Motor</label>
                                            {!showAddMotor ? (
                                                <div style={{ display: 'flex', gap: '10px' }}>
                                                    <select 
                                                        name="motor" 
                                                        value={formData.motor} 
                                                        onChange={handleChange} 
                                                        className="form-select"
                                                        style={{ flex: 1 }}
                                                    >
                                                        <option value="">Selecione...</option>
                                                        {todosMotores.map(m => (
                                                            <option key={m} value={m}>{m}</option>
                                                        ))}
                                                    </select>
                                                    <button 
                                                        type="button"
                                                        className="btn btn-secondary" 
                                                        onClick={() => setShowAddMotor(true)}
                                                        style={{ padding: '8px 16px' }}
                                                    >
                                                        +
                                                    </button>
                                                </div>
                                            ) : (
                                                <div style={{ display: 'flex', gap: '10px' }}>
                                                    <input 
                                                        type="text"
                                                        className="form-input"
                                                        placeholder="Ex: 1.6, 2.0..."
                                                        value={novoMotor}
                                                        onChange={(e) => setNovoMotor(e.target.value)}
                                                        style={{ flex: 1 }}
                                                    />
                                                    <button 
                                                        type="button"
                                                        className="btn btn-success" 
                                                        onClick={adicionarMotor}
                                                        style={{ padding: '8px 16px' }}
                                                    >
                                                        ‚úì
                                                    </button>
                                                    <button 
                                                        type="button"
                                                        className="btn btn-danger" 
                                                        onClick={() => {
                                                            setShowAddMotor(false);
                                                            setNovoMotor('');
                                                        }}
                                                        style={{ padding: '8px 16px' }}
                                                    >
                                                        ‚úï
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {step === 2 && (
                                <div>
                                    <div className="section-title">Selecione os Servi√ßos</div>
                                    
                                    <div className="checkbox-group">
                                        <input type="checkbox" id="oleoMotor" name="oleoMotor" checked={formData.oleoMotor} onChange={handleChange} />
                                        <label htmlFor="oleoMotor">√ìleo de Motor</label>
                                    </div>
                                    {formData.oleoMotor && (
                                        <div className="form-row" style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">Marca do √ìleo</label>
                                                <input type="text" name="oleoMarca" value={formData.oleoMarca} onChange={handleChange} className="form-input" placeholder="Ex: Mobil" />
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Quantidade (L)</label>
                                                <input type="number" step="0.01" name="oleoQuantidade" value={formData.oleoQuantidade} onChange={handleChange} className="form-input" placeholder="Ex: 4.5" />
                                            </div>
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="filtroOleo" name="filtroOleo" checked={formData.filtroOleo} onChange={handleChange} />
                                        <label htmlFor="filtroOleo">Filtro de √ìleo</label>
                                    </div>
                                    {formData.filtroOleo && (
                                        <div style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">Tipo do Filtro</label>
                                                <input type="text" name="filtroOleoTipo" value={formData.filtroOleoTipo} onChange={handleChange} className="form-input" placeholder="Ex: Tecfil PSL140" />
                                            </div>
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="arMotor" name="arMotor" checked={formData.arMotor} onChange={handleChange} />
                                        <label htmlFor="arMotor">Filtro Ar Motor</label>
                                    </div>
                                    {formData.arMotor && (
                                        <div style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">C√≥digo do Filtro</label>
                                                <input type="text" name="arMotorCodigo" value={formData.arMotorCodigo} onChange={handleChange} className="form-input" placeholder="Ex: ARS9123" />
                                            </div>
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="arCondicionado" name="arCondicionado" checked={formData.arCondicionado} onChange={handleChange} />
                                        <label htmlFor="arCondicionado">Filtro Ar Condicionado</label>
                                    </div>
                                    {formData.arCondicionado && (
                                        <div style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">C√≥digo do Filtro</label>
                                                <input type="text" name="arCondicionadoCodigo" value={formData.arCondicionadoCodigo} onChange={handleChange} className="form-input" placeholder="Ex: ARC8765" />
                                            </div>
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="filtroCombustivel" name="filtroCombustivel" checked={formData.filtroCombustivel} onChange={handleChange} />
                                        <label htmlFor="filtroCombustivel">Filtro de Combust√≠vel</label>
                                    </div>
                                    {formData.filtroCombustivel && (
                                        <div style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">C√≥digo do Filtro</label>
                                                <input type="text" name="filtroCombustivelCodigo" value={formData.filtroCombustivelCodigo} onChange={handleChange} className="form-input" placeholder="Ex: FC9432" />
                                            </div>
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="cambioManual" name="cambioManual" checked={formData.cambioManual} onChange={handleChange} />
                                        <label htmlFor="cambioManual">Troca C√¢mbio Manual</label>
                                    </div>
                                    {formData.cambioManual && (
                                        <div className="form-row" style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">Marca do √ìleo</label>
                                                <input type="text" name="cambioManualMarca" value={formData.cambioManualMarca} onChange={handleChange} className="form-input" placeholder="Ex: Motul" />
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Quantidade (L)</label>
                                                <input type="number" step="0.01" name="cambioManualQuantidade" value={formData.cambioManualQuantidade} onChange={handleChange} className="form-input" placeholder="Ex: 2.0" />
                                            </div>
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="cambioAutomatico" name="cambioAutomatico" checked={formData.cambioAutomatico} onChange={handleChange} />
                                        <label htmlFor="cambioAutomatico">Troca C√¢mbio Autom√°tico</label>
                                    </div>
                                    {formData.cambioAutomatico && (
                                        <div style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label className="form-label">Marca do √ìleo</label>
                                                    <input type="text" name="cambioAutomaticoMarca" value={formData.cambioAutomaticoMarca} onChange={handleChange} className="form-input" placeholder="Ex: Shell" />
                                                </div>
                                                <div className="form-group">
                                                    <label className="form-label">Quantidade (L)</label>
                                                    <input type="number" step="0.01" name="cambioAutomaticoQuantidade" value={formData.cambioAutomaticoQuantidade} onChange={handleChange} className="form-input" placeholder="Ex: 4.0" />
                                                </div>
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Quantidade de Flu√≠do no Carter (L)</label>
                                                <input type="number" step="0.01" name="cambioAutomaticoFluidoCarter" value={formData.cambioAutomaticoFluidoCarter || ''} onChange={handleChange} className="form-input" placeholder="Ex: 2.50" />
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Tem filtro?</label>
                                                <select name="cambioAutomaticoTemFiltro" value={formData.cambioAutomaticoTemFiltro} onChange={handleChange} className="form-select">
                                                    <option value={false}>N√£o</option>
                                                    <option value={true}>Sim</option>
                                                </select>
                                            </div>
                                            {formData.cambioAutomaticoTemFiltro === 'true' && (
                                                <div className="form-group">
                                                    <label className="form-label">C√≥digo do Filtro</label>
                                                    <input type="text" name="cambioAutomaticoFiltroCodigo" value={formData.cambioAutomaticoFiltroCodigo} onChange={handleChange} className="form-input" placeholder="Ex: CAF5678" />
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="palhetas" name="palhetas" checked={formData.palhetas} onChange={handleChange} />
                                        <label htmlFor="palhetas">Troca de Palhetas</label>
                                    </div>
                                    {formData.palhetas && (
                                        <div style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">C√≥digo</label>
                                                <input type="text" name="palhetasCodigo" value={formData.palhetasCodigo} onChange={handleChange} className="form-input" placeholder="Ex: PAL2226" />
                                            </div>
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="militec" name="militec" checked={formData.militec} onChange={handleChange} />
                                        <label htmlFor="militec">Militec/Nano</label>
                                    </div>

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="aditivo" name="aditivo" checked={formData.aditivo} onChange={handleChange} />
                                        <label htmlFor="aditivo">Aditivo</label>
                                    </div>
                                    {formData.aditivo && (
                                        <div style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">Qual Aditivo?</label>
                                                <input type="text" name="aditivoQual" value={formData.aditivoQual} onChange={handleChange} className="form-input" placeholder="Ex: STP" />
                                            </div>
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="flush" name="flush" checked={formData.flush} onChange={handleChange} />
                                        <label htmlFor="flush">Flush</label>
                                    </div>
                                    {formData.flush && (
                                        <div style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">Descri√ß√£o</label>
                                                <textarea name="flushDescricao" value={formData.flushDescricao} onChange={handleChange} className="form-textarea" placeholder="Descreva o servi√ßo de flush" rows="3"></textarea>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {step === 3 && (
                                <div>
                                    <div className="form-group">
                                        <label className="form-label">Cliente est√° apto para receber ofertas? *</label>
                                        <select name="apto" value={formData.apto} onChange={handleChange} className="form-select" required>
                                            <option value="sim">Sim</option>
                                            <option value="nao">N√£o</option>
                                        </select>
                                    </div>

                                    {formData.apto === 'nao' && (
                                        <div className="form-group">
                                            <label className="form-label">Motivo *</label>
                                            <textarea name="motivoNaoApto" value={formData.motivoNaoApto} onChange={handleChange} className="form-textarea" placeholder="Por que o cliente n√£o est√° apto?" required></textarea>
                                        </div>
                                    )}

                                    <div className="form-group">
                                        <label className="form-label">Valor da Venda Inicial (R$) *</label>
                                        <input type="number" step="0.01" name="valorInicial" value={formData.valorInicial} onChange={handleChange} className="form-input" placeholder="0.00" required />
                                    </div>

                                    <div className="alert alert-info">
                                        <strong>Resumo da Ordem</strong>
                                        <div style={{ marginTop: '10px' }}>
                                            <div><strong>Cliente:</strong> {formData.cliente}</div>
                                            <div><strong>Placa:</strong> {formData.placa}</div>
                                            <div><strong>Ve√≠culo:</strong> {formData.marca} {formData.modelo}</div>
                                            <div><strong>Vendedor:</strong> {formData.vendedor}</div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div style={{ display: 'flex', gap: '15px', marginTop: '30px', justifyContent: 'space-between' }}>
                                {step > 1 && (
                                    <button className="btn btn-secondary" onClick={() => setStep(step - 1)}>
                                        ‚Üê Voltar
                                    </button>
                                )}
                                {step < 3 ? (
                                    <button className="btn btn-primary" onClick={handleNext} style={{ marginLeft: 'auto' }}>
                                        Pr√≥ximo ‚Üí
                                    </button>
                                ) : (
                                    <button className="btn btn-success" onClick={handleSubmit} style={{ marginLeft: 'auto' }}>
                                        ‚úì Criar Ordem
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Modal Executar Servi√ßo
        function ExecutarServicoModal({ order, onClose, onSuccess }) {
            const [step, setStep] = useState(1);
            const [formData, setFormData] = useState({
                lubrificador: order.lubrificador || '',
                inicio: order.inicio || getBrasilDateTime(),
                km: order.km || '',
                fotos: [],
                upsells: order.upsells || {},
                obsCarro: order.obsCarro || '',
                obsOferta: order.obsOferta || '',
                valorAdd: '0'
            });

            // Auto-save: Salvar progresso no Firebase a cada mudan√ßa
            useEffect(() => {
                const saveProgress = async () => {
                    // S√≥ salvar se j√° preencheu algo
                    if (formData.lubrificador || formData.km) {
                        try {
                            await db.collection('orders').doc(order.id).update({
                                lubrificador: formData.lubrificador,
                                km: formData.km,
                                obsCarro: formData.obsCarro,
                                obsOferta: formData.obsOferta
                            });
                            console.log('Progresso salvo automaticamente');
                        } catch (error) {
                            console.error('Erro ao salvar progresso:', error);
                        }
                    }
                };

                // Debounce: Esperar 2 segundos ap√≥s √∫ltima mudan√ßa para salvar
                const timeoutId = setTimeout(saveProgress, 2000);
                return () => clearTimeout(timeoutId);
            }, [formData.lubrificador, formData.km, formData.obsCarro, formData.obsOferta, order.id]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: value
                }));
            };

            const handleUpsellChange = (servico, field, value) => {
                setFormData(prev => ({
                    ...prev,
                    upsells: {
                        ...prev.upsells,
                        [servico]: {
                            ...(prev.upsells[servico] || {}),
                            [field]: value
                        }
                    }
                }));
            };

            const calcularValorUpsell = () => {
                let total = 0;
                try {
                    if (formData.upsells && typeof formData.upsells === 'object') {
                        Object.values(formData.upsells).forEach(upsell => {
                            if (upsell && upsell.oferecido && upsell.aceito === 'sim' && upsell.valor) {
                                const valor = parseFloat(upsell.valor);
                                if (!isNaN(valor)) {
                                    total += valor;
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Erro ao calcular valor upsell:', error);
                    return 0;
                }
                return total;
            };

            const handleFinalizar = async () => {
                if (!formData.lubrificador) {
                    alert('Selecione o lubrificador');
                    return;
                }

                if (!formData.km) {
                    alert('Informe a quilometragem do ve√≠culo');
                    return;
                }

                try {
                    const fim = getBrasilDateTime();
                    const valorUpsell = calcularValorUpsell();
                    const valorTotal = parseFloat(order.valorInicial || 0) + valorUpsell;
                    
                    // Limpar objeto upsells - remover campos vazios/incompletos
                    const upsellsLimpo = {};
                    let totalOfertasFeitas = 0; // Contador de ofertas realizadas
                    let ofertasAceitas = 0; // Contador de ofertas aceitas
                    
                    Object.keys(formData.upsells || {}).forEach(key => {
                        const upsell = formData.upsells[key];
                        // S√≥ incluir se realmente foi oferecido E tem resposta do cliente
                        if (upsell && upsell.oferecido && upsell.aceito) {
                            totalOfertasFeitas++; // Incrementar contador de ofertas
                            
                            upsellsLimpo[key] = {
                                oferecido: true,
                                aceito: upsell.aceito,
                                valor: upsell.valor || '0'
                            };
                            
                            if (upsell.aceito === 'sim') {
                                ofertasAceitas++;
                            }
                            
                            // Adicionar foto apenas se existir e n√£o for muito grande
                            if (upsell.foto) {
                                // Verificar tamanho (base64 ~1.37x o tamanho real)
                                const fotoSize = (upsell.foto.length * 0.75) / 1024; // KB
                                if (fotoSize < 500) { // Limite de 500KB por foto
                                    upsellsLimpo[key].foto = upsell.foto;
                                } else {
                                    console.warn(`Foto do ${key} muito grande (${fotoSize.toFixed(0)}KB), n√£o ser√° salva`);
                                    alert(`‚ö†Ô∏è Foto do filtro muito grande. Ser√° salva sem a foto.`);
                                }
                            }
                        }
                    });
                    
                    const quantidadeItensUpsell = Object.keys(upsellsLimpo).filter(
                        key => upsellsLimpo[key].aceito === 'sim'
                    ).length;
                    
                    // M√âTRICAS PARA SISTEMA DE METAS
                    const clienteAptoRecebeuOferta = order.apto === 'sim' && totalOfertasFeitas > 0;
                    const taxaConversaoOferta = totalOfertasFeitas > 0 ? (ofertasAceitas / totalOfertasFeitas) * 100 : 0;

                    const updateData = {
                        lubrificador: formData.lubrificador,
                        inicio: formData.inicio,
                        km: formData.km,
                        obsCarro: formData.obsCarro || '',
                        obsOferta: formData.obsOferta || '',
                        upsells: upsellsLimpo,
                        status: 'concluido',
                        fim,
                        valorUpsell,
                        valorTotal,
                        fezUpsell: quantidadeItensUpsell > 0,
                        quantidadeItensUpsell,
                        // NOVOS CAMPOS PARA METAS
                        totalOfertasFeitas, // Quantas ofertas o t√©cnico fez
                        clienteAptoRecebeuOferta, // true/false se cliente apto recebeu oferta
                        taxaConversaoOferta, // % de convers√£o das ofertas feitas
                        tempoEspera: order.dataHora && formData.inicio ? calcularDiferencaTempo(
                            new Date(order.dataHora).toLocaleString('pt-BR'),
                            formData.inicio
                        ) : 'N/A',
                        tempoServico: calcularDiferencaTempo(formData.inicio, fim)
                    };

                    console.log('Dados a serem salvos:', updateData);
                    
                    await db.collection('orders').doc(order.id).update(updateData);
                    
                    // Sincronizar com Google Sheets
                    await syncToSheets('update', { id: order.id, ...order, ...updateData });
                    
                    alert('Servi√ßo finalizado com sucesso!');
                    onSuccess();
                } catch (error) {
                    console.error('Erro detalhado ao finalizar servi√ßo:', error);
                    console.error('Dados que tentou salvar:', formData);
                    alert('Erro ao finalizar servi√ßo. Verifique o console (F12) para detalhes.');
                }
            };

            // TODOS os servi√ßos dispon√≠veis para upsell (n√£o s√≥ os n√£o vendidos)
            const servicosDisponiveis = [
                { key: 'oleoMotor', label: '√ìleo de Motor', vendido: order.oleoMotor },
                { key: 'filtroOleo', label: 'Filtro de √ìleo', vendido: order.filtroOleo },
                { key: 'arMotor', label: 'Filtro Ar Motor', vendido: order.arMotor, temFoto: true },
                { key: 'arCondicionado', label: 'Filtro Ar Condicionado', vendido: order.arCondicionado, temFoto: true },
                { key: 'filtroCombustivel', label: 'Filtro Combust√≠vel', vendido: order.filtroCombustivel, temFoto: true },
                { key: 'cambioManual', label: 'C√¢mbio Manual', vendido: order.cambioManual },
                { key: 'cambioAutomatico', label: 'C√¢mbio Autom√°tico', vendido: order.cambioAutomatico },
                { key: 'palhetas', label: 'Palhetas', vendido: order.palhetas },
                { key: 'militec', label: 'Militec/Nano', vendido: order.militec },
                { key: 'aditivo', label: 'Aditivo', vendido: order.aditivo },
                { key: 'flush', label: 'Flush', vendido: order.flush }
            ];
            
            // PITCHES DE VENDA INTELIGENTES
            const pitchesVenda = {
                arMotor: {
                    pitch: "Sr(a). Cliente, percebi que o filtro de ar do motor est√° sujo. Trocar agora vai melhorar a performance e economizar combust√≠vel!",
                    beneficios: ["Mais pot√™ncia do motor", "Economia de at√© 10% de combust√≠vel", "Motor protegido contra impurezas"]
                },
                arCondicionado: {
                    pitch: "O filtro do ar condicionado est√° com apar√™ncia de sujo. Trocar agora deixa o ar mais limpo e gelado!",
                    beneficios: ["Ar mais gelado", "Elimina mau cheiro", "Protege contra alergias e bact√©rias"]
                },
                filtroCombustivel: {
                    pitch: "Sr(a). Cliente, o filtro de combust√≠vel est√° vencido. Trocar previne problemas no bico injetor que saem bem mais caro!",
                    beneficios: ["Previne entupimento do bico injetor", "Economia com manuten√ß√£o futura", "Motor roda mais suave"]
                },
                cambioAutomatico: {
                    pitch: "A troca de √≥leo do c√¢mbio autom√°tico √© essencial! Evita trocas travando e prolonga a vida √∫til.",
                    beneficios: ["Trocas mais suaves", "Prolonga vida do c√¢mbio", "Evita conserto de R$ 5.000+"]
                },
                cambioManual: {
                    pitch: "O √≥leo do c√¢mbio manual tamb√©m precisa ser trocado! Protege as engrenagens e facilita as trocas.",
                    beneficios: ["Trocas de marcha mais f√°ceis", "Protege engrenagens", "Aumenta durabilidade"]
                },
                palhetas: {
                    pitch: "As palhetas est√£o gastas. Em √©poca de chuva √© perigoso! Trocar agora garante visibilidade total.",
                    beneficios: ["Seguran√ßa em dias de chuva", "Visibilidade perfeita", "Evita riscar o para-brisa"]
                },
                militec: {
                    pitch: "O Militec reduz o atrito do motor e pode economizar at√© 15% de combust√≠vel. Prote√ß√£o extra que compensa!",
                    beneficios: ["Economia de combust√≠vel", "Motor mais silencioso", "Prote√ß√£o contra desgaste"]
                },
                aditivo: {
                    pitch: "O aditivo de radiador protege contra superaquecimento. √â barato e evita preju√≠zo grande!",
                    beneficios: ["Previne superaquecimento", "Protege bomba d'√°gua", "Custo-benef√≠cio excelente"]
                },
                flush: {
                    pitch: "O flush limpa toda a sujeira interna do motor. Deixa o √≥leo novo trabalhar melhor e prolonga a vida do motor!",
                    beneficios: ["Limpa sujeira acumulada", "Melhora efici√™ncia do √≥leo", "Prolonga vida do motor"]
                }
            };

            return (
                <div className="modal">
                    <div className="modal-content">
                        <div className="modal-header">
                            <div className="modal-title">Executar Servi√ßo - Ordem #{order.numeroOrdem}</div>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>
                        
                        <div className="modal-body">
                            {step === 1 && (
                                <div>
                                    <div className="alert alert-info">
                                        <div><strong>Placa:</strong> {order.placa}</div>
                                        <div><strong>Ve√≠culo:</strong> {order.marca} {order.modelo} {order.motor}</div>
                                        <div><strong>Ano:</strong> {order.ano}</div>
                                        <div><strong>Cliente:</strong> {order.cliente}</div>
                                        <div><strong>Vendedor:</strong> {order.vendedor}</div>
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label">Lubrificador *</label>
                                        <div style={{ display: 'flex', gap: '10px' }}>
                                            <select name="lubrificador" value={formData.lubrificador} onChange={handleChange} className="form-select" style={{ flex: 1 }} required>
                                                <option value="">Selecione...</option>
                                                <option value="Caio">Caio</option>
                                                <option value="Luis">Luis</option>
                                                <option value="Pedro">Pedro</option>
                                                <option value="Leo">Leo</option>
                                                {(() => {
                                                    const customLubs = JSON.parse(localStorage.getItem('customLubrificadores') || '[]');
                                                    return customLubs.map(lub => (
                                                        <option key={lub} value={lub}>{lub}</option>
                                                    ));
                                                })()}
                                            </select>
                                            <button 
                                                type="button"
                                                className="btn btn-secondary" 
                                                style={{ padding: '8px 15px', minWidth: '40px' }}
                                                onClick={() => {
                                                    const novoLub = prompt('Digite o nome do novo lubrificador:');
                                                    if (novoLub && novoLub.trim()) {
                                                        const customLubs = JSON.parse(localStorage.getItem('customLubrificadores') || '[]');
                                                        if (!customLubs.includes(novoLub.trim())) {
                                                            customLubs.push(novoLub.trim());
                                                            localStorage.setItem('customLubrificadores', JSON.stringify(customLubs));
                                                            setFormData(prev => ({ ...prev, lubrificador: novoLub.trim() }));
                                                            alert('Lubrificador adicionado com sucesso!');
                                                        } else {
                                                            alert('Este lubrificador j√° existe!');
                                                        }
                                                    }
                                                }}
                                            >
                                                +
                                            </button>
                                        </div>
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label">Quilometragem (KM) *</label>
                                        <input type="number" name="km" value={formData.km} onChange={handleChange} className="form-input" placeholder="Ex: 45000" required />
                                    </div>

                                    <div className="section-title">Servi√ßos a Realizar</div>
                                    <div className="services-list">
                                        {order.oleoMotor && <div className="service-item">‚úì √ìleo Motor ({order.oleoMarca} - {order.oleoQuantidade}L)</div>}
                                        {order.filtroOleo && <div className="service-item">‚úì Filtro √ìleo ({order.filtroOleoTipo})</div>}
                                        {order.arMotor && <div className="service-item">‚úì Filtro Ar Motor ({order.arMotorCodigo})</div>}
                                        {order.arCondicionado && <div className="service-item">‚úì Filtro Ar Condicionado ({order.arCondicionadoCodigo})</div>}
                                        {order.filtroCombustivel && <div className="service-item">‚úì Filtro Combust√≠vel ({order.filtroCombustivelCodigo})</div>}
                                        {order.cambioManual && <div className="service-item">‚úì C√¢mbio Manual ({order.cambioManualMarca} - {order.cambioManualQuantidade}L)</div>}
                                        {/* MELHORIA #3: Detalhes completos de c√¢mbio autom√°tico */}
                                        {order.cambioAutomatico && (
                                            <div className="service-item">
                                                ‚úì C√¢mbio Autom√°tico ({order.cambioAutomaticoMarca} - {order.cambioAutomaticoQuantidade}L
                                                {order.cambioAutomaticoFluidoCarter && ` + Carter: ${order.cambioAutomaticoFluidoCarter}L`}
                                                {order.cambioAutomaticoQuantidade && order.cambioAutomaticoFluidoCarter && 
                                                    ` = Total: ${(parseFloat(order.cambioAutomaticoQuantidade) + parseFloat(order.cambioAutomaticoFluidoCarter)).toFixed(1)}L`
                                                })
                                            </div>
                                        )}
                                        {order.palhetas && <div className="service-item">‚úì Palhetas ({order.palhetasCodigo})</div>}
                                        {order.militec && <div className="service-item">‚úì Militec/Nano</div>}
                                        {order.aditivo && <div className="service-item">‚úì Aditivo ({order.aditivoQual})</div>}
                                        {order.flush && <div className="service-item">‚úì Flush</div>}
                                    </div>

                                    {order.apto === 'sim' ? (
                                        <div className="alert alert-success">
                                            <strong>‚úÖ CLIENTE ACEITA OFERTAS!</strong>
                                            <div>Ofere√ßa servi√ßos adicionais na pr√≥xima etapa</div>
                                        </div>
                                    ) : (
                                        <div className="alert alert-danger">
                                            <strong>‚ùå N√ÉO OFERECER SERVI√áOS EXTRAS</strong>
                                            <div>Motivo: {order.motivoNaoApto}</div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {step === 2 && order.apto === 'sim' && (
                                <div>
                                    <div className="section-title">Ofertas Adicionais (Upsell)</div>
                                    
                                    {servicosDisponiveis.length === 0 ? (
                                        <div className="alert alert-info">
                                            Todos os servi√ßos j√° foram vendidos pelo vendedor.
                                        </div>
                                    ) : (
                                        servicosDisponiveis.map(({ key, label, vendido, temFoto }) => (
                                            <div key={key} style={{ marginBottom: '20px', padding: '15px', background: vendido ? '#e6ffed' : '#f7fafc', borderRadius: '8px', borderLeft: vendido ? '4px solid #48bb78' : 'none' }}>
                                                <div className="checkbox-group">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={formData.upsells[key]?.oferecido || false}
                                                        onChange={(e) => handleUpsellChange(key, 'oferecido', e.target.checked)}
                                                        disabled={vendido}
                                                    />
                                                    <label style={{ fontWeight: 'bold', flex: 1 }}>
                                                        {label}
                                                        {vendido && <span style={{ color: '#48bb78', fontSize: '12px', marginLeft: '10px' }}>‚úì J√° vendido pelo vendedor</span>}
                                                    </label>
                                                </div>
                                                
                                                {formData.upsells[key]?.oferecido && (
                                                    <div style={{ marginTop: '10px', marginLeft: '30px' }}>
                                                        {/* PITCH DE VENDA */}
                                                        {pitchesVenda[key] && (
                                                            <div style={{ 
                                                                background: '#fff3cd', 
                                                                border: '2px solid #ffc107', 
                                                                borderRadius: '8px', 
                                                                padding: '15px', 
                                                                marginBottom: '15px' 
                                                            }}>
                                                                <div style={{ fontWeight: 'bold', color: '#856404', marginBottom: '8px', fontSize: '14px' }}>
                                                                    üí¨ PITCH DE VENDA:
                                                                </div>
                                                                <div style={{ fontSize: '13px', color: '#856404', marginBottom: '10px', fontStyle: 'italic' }}>
                                                                    "{pitchesVenda[key].pitch}"
                                                                </div>
                                                                <div style={{ fontWeight: 'bold', color: '#856404', marginBottom: '5px', fontSize: '13px' }}>
                                                                    ‚úÖ BENEF√çCIOS:
                                                                </div>
                                                                <ul style={{ margin: '0', paddingLeft: '20px', fontSize: '12px', color: '#856404' }}>
                                                                    {pitchesVenda[key].beneficios.map((beneficio, idx) => (
                                                                        <li key={idx}>{beneficio}</li>
                                                                    ))}
                                                                </ul>
                                                            </div>
                                                        )}
                                                        
                                                        {['arMotor', 'arCondicionado', 'filtroCombustivel'].includes(key) && (
                                                            <div className="form-group">
                                                                <label className="form-label">üì∏ Foto do Filtro (opcional)</label>
                                                                <input 
                                                                    type="file" 
                                                                    accept="image/*"
                                                                    capture="environment"
                                                                    className="form-input"
                                                                    onChange={(e) => {
                                                                        const file = e.target.files[0];
                                                                        if (file) {
                                                                            const reader = new FileReader();
                                                                            reader.onloadend = () => {
                                                                                handleUpsellChange(key, 'foto', reader.result);
                                                                            };
                                                                            reader.readAsDataURL(file);
                                                                        }
                                                                    }}
                                                                />
                                                                {formData.upsells[key]?.foto && (
                                                                    <img 
                                                                        src={formData.upsells[key].foto} 
                                                                        alt="Preview" 
                                                                        className="photo-preview"
                                                                        style={{ marginTop: '10px' }}
                                                                    />
                                                                )}
                                                            </div>
                                                        )}
                                                        
                                                        <div className="form-group">
                                                            <label className="form-label">Cliente aceitou? *</label>
                                                            <select 
                                                                className="form-select"
                                                                value={formData.upsells[key]?.aceito || ''}
                                                                onChange={(e) => handleUpsellChange(key, 'aceito', e.target.value)}
                                                            >
                                                                <option value="">Selecione...</option>
                                                                <option value="sim">‚úÖ Sim, aceitou!</option>
                                                                <option value="nao">‚ùå N√£o aceitou</option>
                                                                <option value="sem-estoque">üì¶ N√£o tinha em estoque</option>
                                                            </select>
                                                        </div>

                                                        {formData.upsells[key]?.aceito === 'sim' && (
                                                            <div className="form-group">
                                                                <label className="form-label">Valor (R$)</label>
                                                                <input 
                                                                    type="number" 
                                                                    step="0.01"
                                                                    className="form-input"
                                                                    placeholder="0.00"
                                                                    value={formData.upsells[key]?.valor || ''}
                                                                    onChange={(e) => handleUpsellChange(key, 'valor', e.target.value)}
                                                                />
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        ))
                                    )}
                                </div>
                            )}

                            {(step === 3 || (step === 2 && order.apto !== 'sim')) && (
                                <div>
                                    <div className="form-group">
                                        <label className="form-label">Observa√ß√µes sobre o Carro</label>
                                        <textarea 
                                            name="obsCarro" 
                                            value={formData.obsCarro} 
                                            onChange={handleChange} 
                                            className="form-textarea" 
                                            placeholder="Ex: Vazamento de √≥leo, pneus gastos..."
                                            rows="3"
                                        ></textarea>
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label">Observa√ß√µes sobre Ofertas</label>
                                        <textarea 
                                            name="obsOferta" 
                                            value={formData.obsOferta} 
                                            onChange={handleChange} 
                                            className="form-textarea" 
                                            placeholder="Ex: N√£o tinha filtro em estoque, cliente recusou servi√ßo..."
                                            rows="3"
                                        ></textarea>
                                    </div>

                                    <div className="value-display">
                                        <div className="value-row">
                                            <span className="value-label">Valor Inicial:</span>
                                            <span className="value-amount">R$ {parseFloat(order.valorInicial || 0).toFixed(2)}</span>
                                        </div>
                                        {calcularValorUpsell() > 0 && (
                                            <div className="value-row">
                                                <span className="value-label">Valor Adicional (Upsell):</span>
                                                <span className="value-amount">+ R$ {calcularValorUpsell().toFixed(2)}</span>
                                            </div>
                                        )}
                                        <div className="value-row value-total">
                                            <span className="value-label">TOTAL:</span>
                                            <span className="value-amount">R$ {(parseFloat(order.valorInicial || 0) + calcularValorUpsell()).toFixed(2)}</span>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div style={{ display: 'flex', gap: '15px', marginTop: '30px', justifyContent: 'space-between' }}>
                                {step > 1 && (
                                    <button className="btn btn-secondary" onClick={() => setStep(step - 1)}>
                                        ‚Üê Voltar
                                    </button>
                                )}
                                {(step === 1 || (step === 2 && order.apto === 'sim' && servicosDisponiveis.length > 0)) ? (
                                    <button className="btn btn-primary" onClick={() => setStep(step + 1)} style={{ marginLeft: 'auto' }}>
                                        Pr√≥ximo ‚Üí
                                    </button>
                                ) : (
                                    <button className="btn btn-success" onClick={handleFinalizar} style={{ marginLeft: 'auto' }}>
                                        ‚úì Finalizar Servi√ßo
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Modal Detalhes
        function DetalhesModal({ order, onClose, onUpdate }) {
            const [editMode, setEditMode] = useState(false);
            const [formData, setFormData] = useState({
                valorInicial: order.valorInicial || '',
                valorUpsell: order.valorUpsell || 0,
                obsCarro: order.obsCarro || '',
                obsOferta: order.obsOferta || '',
                voltouComProblema: order.voltouComProblema || false
            });

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: type === 'checkbox' ? checked : value
                }));
            };

            const handleSave = async () => {
                try {
                    const valorTotal = parseFloat(formData.valorInicial || 0) + parseFloat(formData.valorUpsell || 0);
                    await db.collection('orders').doc(order.id).update({
                        ...formData,
                        valorTotal
                    });
                    alert('Altera√ß√µes salvas com sucesso!');
                    setEditMode(false);
                    onUpdate();
                } catch (error) {
                    console.error('Erro ao salvar:', error);
                    alert('Erro ao salvar altera√ß√µes.');
                }
            };

            return (
                <div className="modal">
                    <div className="modal-content">
                        <div className="modal-header">
                            <div className="modal-title">Detalhes - Ordem #{order.numeroOrdem}</div>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>
                        
                        <div className="modal-body">
                            <div className="section-title">Informa√ß√µes Gerais</div>
                            <div className="info-row">
                                <span className="info-label">Status:</span>
                                <span style={{ 
                                    color: order.status === 'aguardando' ? '#f6ad55' : '#48bb78',
                                    fontWeight: 'bold'
                                }}>
                                    {order.status === 'aguardando' ? 'üü° Aguardando' : 'üü¢ Conclu√≠do'}
                                </span>
                            </div>
                            <div className="info-row">
                                <span className="info-label">Placa:</span>
                                <span>{order.placa}</span>
                            </div>
                            <div className="info-row">
                                <span className="info-label">Cliente:</span>
                                <span>{order.cliente}</span>
                            </div>
                            <div className="info-row">
                                <span className="info-label">Ve√≠culo:</span>
                                <span>{order.marca} {order.modelo} {order.motor} ({order.ano})</span>
                            </div>
                            <div className="info-row">
                                <span className="info-label">Combust√≠vel:</span>
                                <span>{order.combustivel}</span>
                            </div>
                            <div className="info-row">
                                <span className="info-label">Vendedor:</span>
                                <span>{order.vendedor}</span>
                            </div>
                            {order.lubrificador && (
                                <div className="info-row">
                                    <span className="info-label">Lubrificador:</span>
                                    <span>{order.lubrificador}</span>
                                </div>
                            )}

                            <div className="section-title">Tempos</div>
                            <div className="info-row">
                                <span className="info-label">Registro:</span>
                                <span>{order.dataHora ? new Date(order.dataHora).toLocaleString('pt-BR') : 'N/A'}</span>
                            </div>
                            {order.inicio && (
                                <>
                                    <div className="info-row">
                                        <span className="info-label">In√≠cio do Servi√ßo:</span>
                                        <span>{order.inicio}</span>
                                    </div>
                                    <div className="info-row">
                                        <span className="info-label">Fim do Servi√ßo:</span>
                                        <span>{order.fim || 'N/A'}</span>
                                    </div>
                                    {order.tempoEspera && (
                                        <div className="info-row">
                                            <span className="info-label">Tempo de Espera:</span>
                                            <span style={{ fontWeight: 'bold', color: '#f6ad55' }}>{order.tempoEspera}</span>
                                        </div>
                                    )}
                                    {order.tempoServico && (
                                        <div className="info-row">
                                            <span className="info-label">Tempo de Servi√ßo:</span>
                                            <span style={{ fontWeight: 'bold', color: '#48bb78' }}>{order.tempoServico}</span>
                                        </div>
                                    )}
                                </>
                            )}

                            <div className="section-title">Valores</div>
                            <div className="value-display">
                                <div className="value-row">
                                    <span className="value-label">Valor Inicial:</span>
                                    {editMode ? (
                                        <input 
                                            type="number" 
                                            step="0.01"
                                            name="valorInicial"
                                            value={formData.valorInicial}
                                            onChange={handleChange}
                                            className="form-input"
                                            style={{ width: '150px' }}
                                        />
                                    ) : (
                                        <span className="value-amount">R$ {parseFloat(order.valorInicial || 0).toFixed(2)}</span>
                                    )}
                                </div>
                                {order.valorUpsell > 0 && (
                                    <div className="value-row">
                                        <span className="value-label">Valor Adicional (Upsell):</span>
                                        <span className="value-amount">+ R$ {parseFloat(order.valorUpsell || 0).toFixed(2)}</span>
                                    </div>
                                )}
                                <div className="value-row value-total">
                                    <span className="value-label">TOTAL:</span>
                                    <span className="value-amount">R$ {parseFloat(order.valorTotal || order.valorInicial || 0).toFixed(2)}</span>
                                </div>
                            </div>

                            {order.obsCarro && (
                                <>
                                    <div className="section-title">Observa√ß√µes do Carro</div>
                                    {editMode ? (
                                        <textarea 
                                            name="obsCarro"
                                            value={formData.obsCarro}
                                            onChange={handleChange}
                                            className="form-textarea"
                                            rows="3"
                                        ></textarea>
                                    ) : (
                                        <div style={{ padding: '15px', background: '#f7fafc', borderRadius: '8px' }}>
                                            {order.obsCarro}
                                        </div>
                                    )}
                                </>
                            )}

                            {order.obsOferta && (
                                <>
                                    <div className="section-title">Observa√ß√µes sobre Ofertas</div>
                                    {editMode ? (
                                        <textarea 
                                            name="obsOferta"
                                            value={formData.obsOferta}
                                            onChange={handleChange}
                                            className="form-textarea"
                                            rows="3"
                                        ></textarea>
                                    ) : (
                                        <div style={{ padding: '15px', background: '#f7fafc', borderRadius: '8px' }}>
                                            {order.obsOferta}
                                        </div>
                                    )}
                                </>
                            )}

                            {order.status === 'concluido' && (
                                <div className="form-group" style={{ marginTop: '20px' }}>
                                    <div className="checkbox-group">
                                        <input 
                                            type="checkbox"
                                            id="voltouComProblema"
                                            name="voltouComProblema"
                                            checked={formData.voltouComProblema}
                                            onChange={handleChange}
                                            disabled={!editMode}
                                        />
                                        <label htmlFor="voltouComProblema" style={{ color: '#f56565', fontWeight: 'bold' }}>
                                            ‚ö†Ô∏è Cliente voltou com problema
                                        </label>
                                    </div>
                                </div>
                            )}

                            <div style={{ display: 'flex', gap: '15px', marginTop: '30px' }}>
                                {editMode ? (
                                    <>
                                        <button className="btn btn-secondary" onClick={() => setEditMode(false)}>
                                            Cancelar
                                        </button>
                                        <button className="btn btn-success" onClick={handleSave}>
                                            üíæ Salvar
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        <button className="btn btn-secondary" onClick={onClose}>
                                            Fechar
                                        </button>
                                        <button className="btn btn-primary" onClick={() => setEditMode(true)}>
                                            ‚úèÔ∏è Editar
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Modal Editar Ordem (para ordens aguardando ou em andamento)
        function EditarOrdemModal({ order, onClose, onUpdate }) {
            const [formData, setFormData] = useState({
                placa: order.placa || '',
                cliente: order.cliente || '',
                tel: order.tel || '',
                marca: order.marca || '',
                modelo: order.modelo || '',
                motor: order.motor || '',
                ano: order.ano || '',
                km: order.km || '',
                oleoMarca: order.oleoMarca || '',
                oleoQuantidade: order.oleoQuantidade || '',
                filtroOleoTipo: order.filtroOleoTipo || '',
                arMotorCodigo: order.arMotorCodigo || '',
                arCondicionadoCodigo: order.arCondicionadoCodigo || '',
                filtroCombustivelCodigo: order.filtroCombustivelCodigo || '',
                cambioManualMarca: order.cambioManualMarca || '',
                cambioManualQuantidade: order.cambioManualQuantidade || '',
                cambioAutomaticoMarca: order.cambioAutomaticoMarca || '',
                cambioAutomaticoQuantidade: order.cambioAutomaticoQuantidade || '',
                cambioAutomaticoFluidoCarter: order.cambioAutomaticoFluidoCarter || '',
                palhetasCodigo: order.palhetasCodigo || '',
                aditivoQual: order.aditivoQual || '',
                lubrificador: order.lubrificador || '',
                valorInicial: order.valorInicial || ''
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSave = async () => {
                if (!formData.placa || !formData.cliente) {
                    alert('Placa e Cliente s√£o obrigat√≥rios!');
                    return;
                }

                try {
                    await db.collection('orders').doc(order.id).update(formData);
                    
                    // Sincronizar com Google Sheets
                    await syncToSheets('update', { id: order.id, ...order, ...formData });
                    
                    alert('Ordem atualizada com sucesso!');
                    onUpdate();
                    onClose();
                } catch (error) {
                    console.error('Erro ao atualizar ordem:', error);
                    alert('Erro ao atualizar ordem.');
                }
            };

            return (
                <div className="modal">
                    <div className="modal-content">
                        <div className="modal-header">
                            <div className="modal-title">‚úèÔ∏è Editar Ordem #{order.numeroOrdem}</div>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>
                        
                        <div className="modal-body">
                            <div className="alert alert-info">
                                <strong>Status:</strong> {order.status === 'aguardando' ? 'üü° Aguardando' : 'üîµ Em Andamento'}
                            </div>

                            <div className="section-title">Dados do Cliente</div>
                            <div className="form-group">
                                <label className="form-label">Cliente *</label>
                                <input type="text" name="cliente" value={formData.cliente} onChange={handleChange} className="form-input" required />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Telefone</label>
                                <input type="tel" name="tel" value={formData.tel} onChange={handleChange} className="form-input" />
                            </div>

                            <div className="section-title">Dados do Ve√≠culo</div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label className="form-label">Placa *</label>
                                    <input type="text" name="placa" value={formData.placa} onChange={handleChange} className="form-input" required />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Ano</label>
                                    <input type="text" name="ano" value={formData.ano} onChange={handleChange} className="form-input" />
                                </div>
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label className="form-label">Marca</label>
                                    <input type="text" name="marca" value={formData.marca} onChange={handleChange} className="form-input" />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Modelo</label>
                                    <input type="text" name="modelo" value={formData.modelo} onChange={handleChange} className="form-input" />
                                </div>
                            </div>
                            <div className="form-group">
                                <label className="form-label">Motor</label>
                                <input type="text" name="motor" value={formData.motor} onChange={handleChange} className="form-input" />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Quilometragem (KM)</label>
                                <input type="number" name="km" value={formData.km} onChange={handleChange} className="form-input" />
                            </div>

                            <div className="section-title">√ìleo e Filtros</div>
                            {order.oleoMotor && (
                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">Marca do √ìleo</label>
                                        <input type="text" name="oleoMarca" value={formData.oleoMarca} onChange={handleChange} className="form-input" />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Quantidade (L)</label>
                                        <input type="number" step="0.01" name="oleoQuantidade" value={formData.oleoQuantidade} onChange={handleChange} className="form-input" />
                                    </div>
                                </div>
                            )}
                            {order.filtroOleo && (
                                <div className="form-group">
                                    <label className="form-label">Filtro de √ìleo</label>
                                    <input type="text" name="filtroOleoTipo" value={formData.filtroOleoTipo} onChange={handleChange} className="form-input" />
                                </div>
                            )}
                            {order.arMotor && (
                                <div className="form-group">
                                    <label className="form-label">C√≥digo Filtro Ar Motor</label>
                                    <input type="text" name="arMotorCodigo" value={formData.arMotorCodigo} onChange={handleChange} className="form-input" />
                                </div>
                            )}
                            {order.arCondicionado && (
                                <div className="form-group">
                                    <label className="form-label">C√≥digo Filtro Ar Condicionado</label>
                                    <input type="text" name="arCondicionadoCodigo" value={formData.arCondicionadoCodigo} onChange={handleChange} className="form-input" />
                                </div>
                            )}
                            {order.filtroCombustivel && (
                                <div className="form-group">
                                    <label className="form-label">C√≥digo Filtro Combust√≠vel</label>
                                    <input type="text" name="filtroCombustivelCodigo" value={formData.filtroCombustivelCodigo} onChange={handleChange} className="form-input" />
                                </div>
                            )}
                            {order.cambioAutomatico && (
                                <>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Marca C√¢mbio Autom√°tico</label>
                                            <input type="text" name="cambioAutomaticoMarca" value={formData.cambioAutomaticoMarca} onChange={handleChange} className="form-input" />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Quantidade (L)</label>
                                            <input type="number" step="0.01" name="cambioAutomaticoQuantidade" value={formData.cambioAutomaticoQuantidade} onChange={handleChange} className="form-input" />
                                        </div>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Flu√≠do no Carter (L)</label>
                                        <input type="number" step="0.01" name="cambioAutomaticoFluidoCarter" value={formData.cambioAutomaticoFluidoCarter} onChange={handleChange} className="form-input" />
                                    </div>
                                </>
                            )}
                            {order.palhetas && (
                                <div className="form-group">
                                    <label className="form-label">C√≥digo Palhetas</label>
                                    <input type="text" name="palhetasCodigo" value={formData.palhetasCodigo} onChange={handleChange} className="form-input" />
                                </div>
                            )}

                            {order.status === 'andamento' && (
                                <>
                                    <div className="section-title">Dados do Atendimento</div>
                                    <div className="form-group">
                                        <label className="form-label">Lubrificador</label>
                                        <input type="text" name="lubrificador" value={formData.lubrificador} onChange={handleChange} className="form-input" />
                                    </div>
                                </>
                            )}

                            {order.valorInicial && (
                                <div className="form-group">
                                    <label className="form-label">Valor Inicial (R$)</label>
                                    <input type="number" step="0.01" name="valorInicial" value={formData.valorInicial} onChange={handleChange} className="form-input" />
                                </div>
                            )}

                            <div style={{ display: 'flex', gap: '15px', marginTop: '30px' }}>
                                <button className="btn btn-secondary" onClick={onClose}>
                                    Cancelar
                                </button>
                                <button className="btn btn-success" onClick={handleSave}>
                                    üíæ Salvar Altera√ß√µes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // MODAL: CONFIGURA√á√ïES
        // ============================================
        function ConfiguracoesModal({ onClose, onSave }) {
            const [tab, setTab] = useState('metas'); // 'metas', 'periodo', 'sheets', 'alertas'
            const [senha, setSenha] = useState('');
            const [autenticado, setAutenticado] = useState(false);
            const [metas, setMetas] = useState(SYSTEM_CONFIG.METAS);
            const [webhookUrl, setWebhookUrl] = useState(SYSTEM_CONFIG.SHEETS_WEBHOOK_URL);
            const [alertasEnabled, setAlertasEnabled] = useState(SYSTEM_CONFIG.ALERTAS_ENABLED);
            
            // NOVO: Estados para m√™s vigente
            const [mesVigente, setMesVigente] = useState(SYSTEM_CONFIG.MES_VIGENTE.mes);
            const [anoVigente, setAnoVigente] = useState(SYSTEM_CONFIG.MES_VIGENTE.ano);

            const handleLogin = () => {
                if (senha === SYSTEM_CONFIG.ADMIN_PASSWORD) {
                    setAutenticado(true);
                } else {
                    alert('‚ùå Senha incorreta!');
                }
            };

            const handleSalvar = () => {
                // Salvar metas
                salvarMetas(metas);
                
                // Salvar m√™s vigente
                salvarMesVigente(mesVigente, anoVigente);
                
                // Salvar webhook
                if (webhookUrl) {
                    salvarWebhookUrl(webhookUrl);
                }
                
                // Salvar alertas
                localStorage.setItem('alertasEnabled', alertasEnabled);
                SYSTEM_CONFIG.ALERTAS_ENABLED = alertasEnabled;
                
                alert('‚úÖ Configura√ß√µes salvas com sucesso!\n\nüìÖ Per√≠odo de avalia√ß√£o: ' + getNomeMes(mesVigente) + '/' + anoVigente);
                onSave();
            };

            const handleMetaChange = (tecnico, campo, valor) => {
                setMetas(prev => ({
                    ...prev,
                    [tecnico]: {
                        ...prev[tecnico],
                        [campo]: parseFloat(valor)
                    }
                }));
            };

            if (!autenticado) {
                return (
                    <div className="modal-overlay">
                        <div className="modal-container" style={{ maxWidth: '500px' }}>
                            <div className="modal-header">
                                <div className="modal-title">üîí Acesso Restrito</div>
                                <button className="close-btn" onClick={onClose}>‚úï</button>
                            </div>
                            <div className="modal-body">
                                <div style={{ textAlign: 'center', padding: '40px 20px' }}>
                                    <div style={{ fontSize: '60px', marginBottom: '20px' }}>‚öôÔ∏è</div>
                                    <h3 style={{ marginBottom: '10px' }}>Configura√ß√µes do Sistema</h3>
                                    <p style={{ color: '#718096', marginBottom: '30px' }}>
                                        Digite a senha de administrador para continuar
                                    </p>
                                    <input 
                                        type="password"
                                        value={senha}
                                        onChange={(e) => setSenha(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                        placeholder="Senha"
                                        className="form-input"
                                        style={{ marginBottom: '20px', textAlign: 'center', fontSize: '16px' }}
                                        autoFocus
                                    />
                                    <button className="btn btn-primary" style={{ width: '100%' }} onClick={handleLogin}>
                                        üîì Acessar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="modal-overlay">
                    <div className="modal-container" style={{ maxWidth: '800px' }}>
                        <div className="modal-header">
                            <div className="modal-title">‚öôÔ∏è Configura√ß√µes do Sistema</div>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>
                        
                        <div className="modal-body">
                            {/* TABS */}
                            <div style={{ display: 'flex', gap: '10px', marginBottom: '30px', borderBottom: '2px solid #e2e8f0' }}>
                                <button 
                                    onClick={() => setTab('metas')}
                                    style={{
                                        padding: '10px 20px',
                                        background: tab === 'metas' ? '#667eea' : 'transparent',
                                        color: tab === 'metas' ? 'white' : '#4a5568',
                                        border: 'none',
                                        borderBottom: tab === 'metas' ? '3px solid #667eea' : 'none',
                                        cursor: 'pointer',
                                        fontWeight: 'bold'
                                    }}
                                >
                                    üéØ Metas
                                </button>
                                <button 
                                    onClick={() => setTab('periodo')}
                                    style={{
                                        padding: '10px 20px',
                                        background: tab === 'periodo' ? '#667eea' : 'transparent',
                                        color: tab === 'periodo' ? 'white' : '#4a5568',
                                        border: 'none',
                                        borderBottom: tab === 'periodo' ? '3px solid #667eea' : 'none',
                                        cursor: 'pointer',
                                        fontWeight: 'bold'
                                    }}
                                >
                                    üìÖ Per√≠odo
                                </button>
                                <button 
                                    onClick={() => setTab('sheets')}
                                    style={{
                                        padding: '10px 20px',
                                        background: tab === 'sheets' ? '#667eea' : 'transparent',
                                        color: tab === 'sheets' ? 'white' : '#4a5568',
                                        border: 'none',
                                        borderBottom: tab === 'sheets' ? '3px solid #667eea' : 'none',
                                        cursor: 'pointer',
                                        fontWeight: 'bold'
                                    }}
                                >
                                    üìä Google Sheets
                                </button>
                                <button 
                                    onClick={() => setTab('alertas')}
                                    style={{
                                        padding: '10px 20px',
                                        background: tab === 'alertas' ? '#667eea' : 'transparent',
                                        color: tab === 'alertas' ? 'white' : '#4a5568',
                                        border: 'none',
                                        borderBottom: tab === 'alertas' ? '3px solid #667eea' : 'none',
                                        cursor: 'pointer',
                                        fontWeight: 'bold'
                                    }}
                                >
                                    ‚ö†Ô∏è Alertas
                                </button>
                            </div>

                            {/* TAB: METAS */}
                            {tab === 'metas' && (
                                <div>
                                    <h3 style={{ marginBottom: '20px' }}>üéØ Definir Metas por T√©cnico</h3>
                                    <p style={{ color: '#718096', marginBottom: '30px' }}>
                                        Configure as metas individuais de cada lubrificador. O sistema calcula automaticamente o desempenho e gera alertas.
                                    </p>

                                    {Object.keys(metas).map(tecnico => (
                                        <div key={tecnico} style={{
                                            background: '#f7fafc',
                                            padding: '20px',
                                            borderRadius: '10px',
                                            marginBottom: '20px'
                                        }}>
                                            <h4 style={{ marginBottom: '15px', color: '#2d3748' }}>üë§ {tecnico}</h4>
                                            
                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px' }}>
                                                <div>
                                                    <label className="form-label">Meta de Ofertas (%)</label>
                                                    <input 
                                                        type="number"
                                                        min="0"
                                                        max="100"
                                                        value={metas[tecnico].ofertas}
                                                        onChange={(e) => handleMetaChange(tecnico, 'ofertas', e.target.value)}
                                                        className="form-input"
                                                    />
                                                    <div style={{ fontSize: '12px', color: '#718096', marginTop: '5px' }}>
                                                        Clientes aptos devem receber ofertas
                                                    </div>
                                                </div>
                                                
                                                <div>
                                                    <label className="form-label">Meta de Upsell (%)</label>
                                                    <input 
                                                        type="number"
                                                        min="0"
                                                        max="100"
                                                        value={metas[tecnico].upsell}
                                                        onChange={(e) => handleMetaChange(tecnico, 'upsell', e.target.value)}
                                                        className="form-input"
                                                    />
                                                    <div style={{ fontSize: '12px', color: '#718096', marginTop: '5px' }}>
                                                        Convers√£o de vendas adicionais
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}

                                    <div style={{
                                        background: '#e6f2ff',
                                        border: '2px solid #3b82f6',
                                        borderRadius: '8px',
                                        padding: '15px',
                                        marginTop: '20px'
                                    }}>
                                        <strong>üí° Dica:</strong> As metas s√£o usadas para calcular alertas e rankings automaticamente. Ajuste conforme necess√°rio.
                                    </div>
                                </div>
                            )}

                            {/* TAB: PER√çODO DE AVALIA√á√ÉO */}
                            {tab === 'periodo' && (
                                <div>
                                    <h3 style={{ marginBottom: '20px' }}>üìÖ Per√≠odo de Avalia√ß√£o</h3>
                                    <p style={{ color: '#718096', marginBottom: '30px' }}>
                                        Configure qual m√™s ser√° usado para calcular as m√©tricas e gerar os alertas de performance.
                                    </p>

                                    <div style={{
                                        background: '#f7fafc',
                                        padding: '25px',
                                        borderRadius: '10px',
                                        marginBottom: '20px'
                                    }}>
                                        <h4 style={{ marginBottom: '20px', color: '#2d3748' }}>üìÜ M√™s Vigente</h4>
                                        
                                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '20px' }}>
                                            <div>
                                                <label className="form-label">M√™s</label>
                                                <select 
                                                    value={mesVigente}
                                                    onChange={(e) => setMesVigente(parseInt(e.target.value))}
                                                    className="form-select"
                                                    style={{ fontSize: '16px' }}
                                                >
                                                    <option value="1">Janeiro</option>
                                                    <option value="2">Fevereiro</option>
                                                    <option value="3">Mar√ßo</option>
                                                    <option value="4">Abril</option>
                                                    <option value="5">Maio</option>
                                                    <option value="6">Junho</option>
                                                    <option value="7">Julho</option>
                                                    <option value="8">Agosto</option>
                                                    <option value="9">Setembro</option>
                                                    <option value="10">Outubro</option>
                                                    <option value="11">Novembro</option>
                                                    <option value="12">Dezembro</option>
                                                </select>
                                            </div>
                                            
                                            <div>
                                                <label className="form-label">Ano</label>
                                                <select 
                                                    value={anoVigente}
                                                    onChange={(e) => setAnoVigente(parseInt(e.target.value))}
                                                    className="form-select"
                                                    style={{ fontSize: '16px' }}
                                                >
                                                    {[2024, 2025, 2026, 2027].map(ano => (
                                                        <option key={ano} value={ano}>{ano}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>

                                        <div style={{
                                            marginTop: '20px',
                                            padding: '15px',
                                            background: '#e6f2ff',
                                            borderRadius: '8px',
                                            border: '2px solid #3b82f6'
                                        }}>
                                            <div style={{ fontSize: '14px', color: '#1e40af', marginBottom: '8px' }}>
                                                <strong>üìä Per√≠odo Selecionado:</strong>
                                            </div>
                                            <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#1e40af' }}>
                                                {getNomeMes(mesVigente)}/{anoVigente}
                                            </div>
                                        </div>
                                    </div>

                                    <div style={{
                                        background: '#fef3c7',
                                        border: '2px solid #f59e0b',
                                        borderRadius: '8px',
                                        padding: '15px',
                                        marginBottom: '15px'
                                    }}>
                                        <strong>‚ö†Ô∏è Importante:</strong>
                                        <ul style={{ marginTop: '10px', paddingLeft: '20px', marginBottom: 0 }}>
                                            <li>Alertas ser√£o calculados APENAS para este per√≠odo</li>
                                            <li>Ordens fora deste m√™s n√£o aparecer√£o nos alertas</li>
                                            <li>Altere para outro m√™s para ver o hist√≥rico</li>
                                        </ul>
                                    </div>

                                    <div style={{
                                        background: '#e6f2ff',
                                        border: '2px solid #3b82f6',
                                        borderRadius: '8px',
                                        padding: '15px'
                                    }}>
                                        <strong>üí° Como usar:</strong>
                                        <ol style={{ marginTop: '10px', paddingLeft: '20px', marginBottom: 0 }}>
                                            <li>Selecione o m√™s e ano que deseja avaliar</li>
                                            <li>Clique em "Salvar Configura√ß√µes"</li>
                                            <li>Sistema recalcula automaticamente os alertas</li>
                                            <li>Banner mostrar√°: "Per√≠odo de Avalia√ß√£o: [M√™s]/[Ano]"</li>
                                        </ol>
                                    </div>
                                </div>
                            )}

                            {/* TAB: GOOGLE SHEETS */}
                            {tab === 'sheets' && (
                                <div>
                                    <h3 style={{ marginBottom: '20px' }}>üìä Integra√ß√£o com Google Sheets</h3>
                                    
                                    <div className="form-group">
                                        <label className="form-label">URL do Webhook</label>
                                        <input 
                                            type="text"
                                            value={webhookUrl}
                                            onChange={(e) => setWebhookUrl(e.target.value)}
                                            className="form-input"
                                            placeholder="https://script.google.com/macros/s/..."
                                        />
                                        <div style={{ fontSize: '12px', color: '#718096', marginTop: '5px' }}>
                                            Cole a URL gerada ap√≥s fazer deploy do Google Apps Script
                                        </div>
                                    </div>

                                    <div style={{
                                        background: '#fef3c7',
                                        border: '2px solid #f59e0b',
                                        borderRadius: '8px',
                                        padding: '15px',
                                        marginTop: '20px'
                                    }}>
                                        <strong>üìã Como configurar:</strong>
                                        <ol style={{ marginTop: '10px', paddingLeft: '20px' }}>
                                            <li>Abra a planilha Google Sheets</li>
                                            <li>Extensions ‚Üí Apps Script</li>
                                            <li>Cole o c√≥digo do script (arquivo google-apps-script.js)</li>
                                            <li>Deploy ‚Üí New deployment ‚Üí Web app</li>
                                            <li>Copie a URL gerada e cole acima</li>
                                        </ol>
                                    </div>

                                    <div style={{
                                        background: '#e6f2ff',
                                        border: '2px solid #3b82f6',
                                        borderRadius: '8px',
                                        padding: '15px',
                                        marginTop: '15px'
                                    }}>
                                        <strong>‚úÖ Status:</strong> {webhookUrl ? 'üü¢ Configurado' : 'üî¥ N√£o configurado'}
                                    </div>
                                </div>
                            )}

                            {/* TAB: ALERTAS */}
                            {tab === 'alertas' && (
                                <div>
                                    <h3 style={{ marginBottom: '20px' }}>‚ö†Ô∏è Sistema de Alertas</h3>
                                    
                                    <div className="checkbox-group" style={{ marginBottom: '20px' }}>
                                        <input 
                                            type="checkbox"
                                            checked={alertasEnabled}
                                            onChange={(e) => setAlertasEnabled(e.target.checked)}
                                        />
                                        <label style={{ fontSize: '16px' }}>Habilitar alertas de performance</label>
                                    </div>

                                    <div style={{
                                        background: '#f7fafc',
                                        padding: '20px',
                                        borderRadius: '10px',
                                        marginBottom: '15px'
                                    }}>
                                        <h4 style={{ marginBottom: '10px' }}>üìå Como funciona:</h4>
                                        <ul style={{ paddingLeft: '20px', color: '#4a5568' }}>
                                            <li>Sistema calcula automaticamente as m√©tricas de cada t√©cnico</li>
                                            <li>Compara com as metas definidas</li>
                                            <li>Exibe alertas visuais no topo da tela</li>
                                            <li>Alertas s√£o p√∫blicos (todos os t√©cnicos veem)</li>
                                        </ul>
                                    </div>

                                    <div style={{
                                        background: '#fef3c7',
                                        padding: '15px',
                                        borderRadius: '8px'
                                    }}>
                                        <strong>Tipos de Alertas:</strong>
                                        <div style={{ marginTop: '10px' }}>
                                            <div>üî¥ <strong>CR√çTICO:</strong> 3+ clientes aptos sem oferta nas √∫ltimas 10 ordens</div>
                                            <div style={{ marginTop: '5px' }}>üü° <strong>ATEN√á√ÉO:</strong> Taxa abaixo da meta</div>
                                            <div style={{ marginTop: '5px' }}>üü¢ <strong>SUCESSO:</strong> Todas as metas atingidas!</div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div style={{ display: 'flex', gap: '15px', marginTop: '30px' }}>
                                <button className="btn btn-secondary" onClick={onClose}>
                                    Cancelar
                                </button>
                                <button className="btn btn-success" onClick={handleSalvar}>
                                    üíæ Salvar Configura√ß√µes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // MODAL: BUSCAR CLIENTE
        // ============================================
        function BuscarClienteModal({ onClose, onSelectCliente }) {
            const [termo, setTermo] = useState('');
            const [resultados, setResultados] = useState([]);
            const [loading, setLoading] = useState(false);
            const [clienteSelecionado, setClienteSelecionado] = useState(null);

            const handleBuscar = async () => {
                if (termo.length < 3) {
                    alert('Digite pelo menos 3 caracteres');
                    return;
                }

                setLoading(true);
                try {
                    const clientes = await buscarHistoricoCliente(termo);
                    setResultados(clientes);
                } catch (error) {
                    console.error('Erro na busca:', error);
                    alert('Erro ao buscar clientes');
                } finally {
                    setLoading(false);
                }
            };

            const calcularDiasUltimaVisita = (visitas) => {
                if (!visitas || visitas.length === 0) return null;
                
                const datasOrdenadas = visitas
                    .map(v => new Date(v.dataHora))
                    .sort((a, b) => b - a);
                
                const ultimaVisita = datasOrdenadas[0];
                const hoje = new Date();
                const diff = Math.floor((hoje - ultimaVisita) / (1000 * 60 * 60 * 24));
                return diff;
            };

            return (
                <div className="modal-overlay">
                    <div className="modal-container" style={{ maxWidth: '900px' }}>
                        <div className="modal-header">
                            <div className="modal-title">üîç Buscar Cliente</div>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>
                        
                        <div className="modal-body">
                            <div style={{ display: 'flex', gap: '10px', marginBottom: '30px' }}>
                                <input 
                                    type="text"
                                    value={termo}
                                    onChange={(e) => setTermo(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleBuscar()}
                                    placeholder="Digite placa, nome ou telefone..."
                                    className="form-input"
                                    style={{ flex: 1 }}
                                    autoFocus
                                />
                                <button 
                                    className="btn btn-primary"
                                    onClick={handleBuscar}
                                    disabled={loading}
                                >
                                    {loading ? '‚è≥ Buscando...' : 'üîç Buscar'}
                                </button>
                            </div>

                            {resultados.length === 0 && !loading && (
                                <div style={{ textAlign: 'center', padding: '60px 20px', color: '#718096' }}>
                                    <div style={{ fontSize: '60px', marginBottom: '20px' }}>üîç</div>
                                    <h3>Nenhum resultado</h3>
                                    <p>Digite uma placa, nome ou telefone para buscar</p>
                                </div>
                            )}

                            {resultados.length > 0 && (
                                <div>
                                    <h4 style={{ marginBottom: '15px', color: '#2d3748' }}>
                                        üìã {resultados.length} cliente(s) encontrado(s)
                                    </h4>
                                    
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>
                                        {resultados.map((cliente, idx) => {
                                            const dias = calcularDiasUltimaVisita(cliente.visitas);
                                            const taxaUpsell = cliente.visitas.length > 0 
                                                ? (cliente.upsellsAceitos / cliente.visitas.length) * 100 
                                                : 0;

                                            return (
                                                <div 
                                                    key={idx}
                                                    style={{
                                                        background: '#f7fafc',
                                                        padding: '20px',
                                                        borderRadius: '10px',
                                                        border: clienteSelecionado === cliente ? '3px solid #667eea' : '1px solid #e2e8f0',
                                                        cursor: 'pointer',
                                                        transition: 'all 0.2s'
                                                    }}
                                                    onClick={() => setClienteSelecionado(cliente)}
                                                >
                                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                                                        <div>
                                                            <h3 style={{ marginBottom: '5px', color: '#2d3748' }}>
                                                                üöó {cliente.placa} - {cliente.cliente}
                                                            </h3>
                                                            <div style={{ color: '#718096', fontSize: '14px', marginBottom: '15px' }}>
                                                                {cliente.marca} {cliente.modelo} {cliente.motor} - {cliente.ano}
                                                            </div>
                                                            
                                                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '15px' }}>
                                                                <div>
                                                                    <div style={{ fontSize: '12px', color: '#718096' }}>Total Visitas</div>
                                                                    <div style={{ fontSize: '20px', fontWeight: 'bold', color: '#667eea' }}>
                                                                        {cliente.visitas.length}x
                                                                    </div>
                                                                </div>
                                                                
                                                                <div>
                                                                    <div style={{ fontSize: '12px', color: '#718096' }}>√öltima Visita</div>
                                                                    <div style={{ fontSize: '16px', fontWeight: 'bold', color: dias < 30 ? '#48bb78' : dias < 60 ? '#f6ad55' : '#f56565' }}>
                                                                        {dias} dias
                                                                    </div>
                                                                </div>
                                                                
                                                                <div>
                                                                    <div style={{ fontSize: '12px', color: '#718096' }}>Aceita Upsell</div>
                                                                    <div style={{ fontSize: '16px', fontWeight: 'bold', color: taxaUpsell > 50 ? '#48bb78' : '#f6ad55' }}>
                                                                        {taxaUpsell.toFixed(0)}%
                                                                    </div>
                                                                </div>
                                                                
                                                                <div>
                                                                    <div style={{ fontSize: '12px', color: '#718096' }}>Total Gasto</div>
                                                                    <div style={{ fontSize: '16px', fontWeight: 'bold', color: '#667eea' }}>
                                                                        R$ {cliente.totalGasto.toFixed(2)}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        {clienteSelecionado === cliente && (
                                                            <div style={{ color: '#667eea', fontSize: '30px' }}>‚úì</div>
                                                        )}
                                                    </div>

                                                    {clienteSelecionado === cliente && (
                                                        <div style={{
                                                            marginTop: '20px',
                                                            padding: '15px',
                                                            background: 'white',
                                                            borderRadius: '8px',
                                                            maxHeight: '200px',
                                                            overflowY: 'auto'
                                                        }}>
                                                            <h5 style={{ marginBottom: '10px' }}>üìú Hist√≥rico de Visitas:</h5>
                                                            {cliente.visitas.slice(0, 5).map((visita, vIdx) => (
                                                                <div key={vIdx} style={{
                                                                    padding: '8px',
                                                                    marginBottom: '5px',
                                                                    background: '#f7fafc',
                                                                    borderRadius: '5px',
                                                                    fontSize: '13px'
                                                                }}>
                                                                    <strong>#{visita.numeroOrdem}</strong> - {new Date(visita.dataHora).toLocaleDateString('pt-BR')} - 
                                                                    R$ {visita.valorTotal?.toFixed(2) || '0.00'} 
                                                                    {visita.fezUpsell && <span style={{ color: '#48bb78' }}> ‚úì Upsell</span>}
                                                                </div>
                                                            ))}
                                                            {cliente.visitas.length > 5 && (
                                                                <div style={{ fontSize: '12px', color: '#718096', marginTop: '10px' }}>
                                                                    ... e mais {cliente.visitas.length - 5} visitas
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>

                                    {clienteSelecionado && (
                                        <div style={{ display: 'flex', gap: '15px', marginTop: '30px' }}>
                                            <button className="btn btn-secondary" onClick={onClose}>
                                                Cancelar
                                            </button>
                                            <button 
                                                className="btn btn-success"
                                                onClick={() => onSelectCliente(clienteSelecionado)}
                                            >
                                                ‚ûï Criar Nova Ordem para Este Cliente
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Renderizar aplica√ß√£o
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

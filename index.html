<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master √ìleo Curitiba - Sistema de Gest√£o</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .stat {
            text-align: center;
            padding: 10px 20px;
            background: #f7fafc;
            border-radius: 10px;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .btn-danger:hover {
            background: #e53e3e;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            position: relative;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .card-aguardando {
            border-left: 5px solid #f6ad55;
        }
        
        .card-concluido {
            border-left: 5px solid #48bb78;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .order-number {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .queue-position {
            background: #f6ad55;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .card-title {
            font-size: 20px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .card-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .info-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #4a5568;
        }
        
        .info-label {
            font-weight: 600;
            color: #2d3748;
        }
        
        .services-list {
            background: #f7fafc;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .service-item {
            font-size: 13px;
            color: #4a5568;
            padding: 3px 0;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-upsell {
            background: #ffd700;
            color: #744210;
        }
        
        .badge-problem {
            background: #fc8181;
            color: #742a2a;
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            padding: 25px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #718096;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: #f7fafc;
            color: #2d3748;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .checkbox-group:hover {
            background: #edf2f7;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            cursor: pointer;
            font-weight: 500;
            flex: 1;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
        }
        
        .step {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .step-number {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #e2e8f0;
            color: #718096;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .step.active .step-number {
            background: #667eea;
            color: white;
        }
        
        .step.completed .step-number {
            background: #48bb78;
            color: white;
        }
        
        .step-label {
            font-weight: 600;
            color: #718096;
        }
        
        .step.active .step-label {
            color: #667eea;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }
        
        .alert-warning {
            background: #feebc8;
            color: #744210;
            border-left: 4px solid #f6ad55;
        }
        
        .alert-danger {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }
        
        .alert-info {
            background: #bee3f8;
            color: #2c5282;
            border-left: 4px solid #4299e1;
        }
        
        .photo-upload {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .photo-upload:hover {
            border-color: #667eea;
            background: #f7fafc;
        }
        
        .photo-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #2d3748;
            margin: 20px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .value-display {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .value-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 16px;
        }
        
        .value-label {
            font-weight: 600;
            color: #4a5568;
        }
        
        .value-amount {
            font-weight: bold;
            color: #2d3748;
        }
        
        .value-total {
            border-top: 2px solid #cbd5e0;
            padding-top: 12px;
            margin-top: 8px;
        }
        
        .value-total .value-amount {
            color: #667eea;
            font-size: 20px;
        }
        
        @media (max-width: 768px) {
            .cards-container {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDGKmHDcq4ErMxiovaZJl7W2aASQ_WqgGY",
            authDomain: "masteroleo-1ed99.firebaseapp.com",
            projectId: "masteroleo-1ed99",
            storageBucket: "masteroleo-1ed99.firebasestorage.app",
            messagingSenderId: "242752297319",
            appId: "1:242752297319:web:e6384e400ba2abc2aa37c2",
            measurementId: "G-QL78TZBW3V"
        };

        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // Fun√ß√£o para obter data/hora no hor√°rio de Bras√≠lia
        const getBrasilDateTime = () => {
            return new Date().toLocaleString('pt-BR', {
                timeZone: 'America/Sao_Paulo',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        };

        // Fun√ß√£o para formatar data/hora para input
        const formatDateTimeForInput = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        };

        // Fun√ß√£o para calcular diferen√ßa de tempo
        const calcularDiferencaTempo = (inicio, fim) => {
            const dataInicio = new Date(inicio.replace(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2}):(\d{2})/, '$3-$2-$1T$4:$5:$6'));
            const dataFim = new Date(fim.replace(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2}):(\d{2})/, '$3-$2-$1T$4:$5:$6'));
            const diffMs = dataFim - dataInicio;
            const diffMinutes = Math.floor(diffMs / 60000);
            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            return `${hours}h ${minutes}min`;
        };

        // Componente principal
        function App() {
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showNewOrderModal, setShowNewOrderModal] = useState(false);
            const [showExecuteModal, setShowExecuteModal] = useState(false);
            const [showDetailsModal, setShowDetailsModal] = useState(false);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [filterDate, setFilterDate] = useState('today');
            const [customDateStart, setCustomDateStart] = useState('');
            const [customDateEnd, setCustomDateEnd] = useState('');

            // Carregar ordens do Firebase
            const loadOrders = async () => {
                try {
                    setLoading(true);
                    const snapshot = await db.collection('orders').orderBy('numeroOrdem', 'desc').get();
                    const ordersData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setOrders(ordersData);
                } catch (error) {
                    console.error('Erro ao carregar ordens:', error);
                    alert('Erro ao carregar ordens. Verifique o console.');
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                loadOrders();
                const interval = setInterval(loadOrders, 30000); // Auto-refresh a cada 30s
                return () => clearInterval(interval);
            }, []);

            // Filtrar ordens por data
            const getFilteredOrders = () => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                return orders.filter(order => {
                    if (!order.dataHora) return false;

                    const orderDate = new Date(order.dataHora);
                    orderDate.setHours(0, 0, 0, 0);

                    switch (filterDate) {
                        case 'today':
                            return orderDate.getTime() === today.getTime();
                        case 'week':
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            return orderDate >= weekAgo;
                        case 'month':
                            const monthAgo = new Date(today);
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            return orderDate >= monthAgo;
                        case 'custom':
                            if (!customDateStart || !customDateEnd) return true;
                            const start = new Date(customDateStart);
                            const end = new Date(customDateEnd);
                            return orderDate >= start && orderDate <= end;
                        default:
                            return true;
                    }
                });
            };

            const filteredOrders = getFilteredOrders();
            const aguardando = filteredOrders.filter(o => o.status === 'aguardando');
            const concluidos = filteredOrders.filter(o => o.status === 'concluido');

            // Calcular pr√≥ximo n√∫mero de ordem
            const getNextOrderNumber = () => {
                if (orders.length === 0) return 1;
                const maxNumber = Math.max(...orders.map(o => o.numeroOrdem || 0));
                return maxNumber + 1;
            };

            // Fun√ß√£o para cancelar ordem
            const cancelarOrdem = async (orderId) => {
                if (confirm('Tem certeza que deseja cancelar esta ordem?')) {
                    try {
                        await db.collection('orders').doc(orderId).delete();
                        alert('Ordem cancelada com sucesso!');
                        loadOrders();
                    } catch (error) {
                        console.error('Erro ao cancelar ordem:', error);
                        alert('Erro ao cancelar ordem.');
                    }
                }
            };

            return (
                <div className="container">
                    <div className="header">
                        <div className="logo">
                            üöó Master √ìleo Curitiba
                        </div>
                        <div className="stats">
                            <div className="stat">
                                <div className="stat-number">{aguardando.length}</div>
                                <div className="stat-label">Aguardando</div>
                            </div>
                            <div className="stat">
                                <div className="stat-number">{concluidos.length}</div>
                                <div className="stat-label">Conclu√≠dos</div>
                            </div>
                            <div className="stat">
                                <div className="stat-number">{filteredOrders.length}</div>
                                <div className="stat-label">Total</div>
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                            <button className="btn btn-primary" onClick={() => setShowNewOrderModal(true)}>
                                ‚ûï Nova Ordem
                            </button>
                            <button className="btn btn-secondary" onClick={loadOrders}>
                                üîÑ Atualizar
                            </button>
                        </div>
                    </div>

                    <div className="filters">
                        <span style={{ fontWeight: 'bold', color: '#2d3748' }}>Filtrar por:</span>
                        <button 
                            className={`filter-btn ${filterDate === 'today' ? 'active' : ''}`}
                            onClick={() => setFilterDate('today')}
                        >
                            Hoje
                        </button>
                        <button 
                            className={`filter-btn ${filterDate === 'week' ? 'active' : ''}`}
                            onClick={() => setFilterDate('week')}
                        >
                            √öltima Semana
                        </button>
                        <button 
                            className={`filter-btn ${filterDate === 'month' ? 'active' : ''}`}
                            onClick={() => setFilterDate('month')}
                        >
                            √öltimo M√™s
                        </button>
                        <button 
                            className={`filter-btn ${filterDate === 'all' ? 'active' : ''}`}
                            onClick={() => setFilterDate('all')}
                        >
                            Todos
                        </button>
                    </div>

                    {loading ? (
                        <div className="loading">
                            <div className="spinner"></div>
                        </div>
                    ) : (
                        <>
                            {aguardando.length > 0 && (
                                <>
                                    <h2 style={{ color: 'white', marginBottom: '15px', fontSize: '22px' }}>
                                        üü° Aguardando Atendimento ({aguardando.length})
                                    </h2>
                                    <div className="cards-container">
                                        {aguardando.map((order, index) => (
                                            <CardAguardando 
                                                key={order.id} 
                                                order={order} 
                                                position={index + 1}
                                                onIniciar={() => {
                                                    setSelectedOrder(order);
                                                    setShowExecuteModal(true);
                                                }}
                                                onCancelar={() => cancelarOrdem(order.id)}
                                            />
                                        ))}
                                    </div>
                                </>
                            )}

                            {concluidos.length > 0 && (
                                <>
                                    <h2 style={{ color: 'white', marginBottom: '15px', marginTop: '30px', fontSize: '22px' }}>
                                        üü¢ Conclu√≠dos ({concluidos.length})
                                    </h2>
                                    <div className="cards-container">
                                        {concluidos.map(order => (
                                            <CardConcluido 
                                                key={order.id} 
                                                order={order}
                                                onVer={() => {
                                                    setSelectedOrder(order);
                                                    setShowDetailsModal(true);
                                                }}
                                            />
                                        ))}
                                    </div>
                                </>
                            )}

                            {filteredOrders.length === 0 && (
                                <div className="empty-state">
                                    <div className="empty-state-icon">üìã</div>
                                    <h3>Nenhuma ordem encontrada</h3>
                                    <p>Comece criando uma nova ordem</p>
                                </div>
                            )}
                        </>
                    )}

                    {showNewOrderModal && (
                        <NovaOrdemModal 
                            onClose={() => setShowNewOrderModal(false)}
                            onSuccess={() => {
                                setShowNewOrderModal(false);
                                loadOrders();
                            }}
                            nextOrderNumber={getNextOrderNumber()}
                        />
                    )}

                    {showExecuteModal && selectedOrder && (
                        <ExecutarServicoModal 
                            order={selectedOrder}
                            onClose={() => {
                                setShowExecuteModal(false);
                                setSelectedOrder(null);
                            }}
                            onSuccess={() => {
                                setShowExecuteModal(false);
                                setSelectedOrder(null);
                                loadOrders();
                            }}
                        />
                    )}

                    {showDetailsModal && selectedOrder && (
                        <DetalhesModal 
                            order={selectedOrder}
                            onClose={() => {
                                setShowDetailsModal(false);
                                setSelectedOrder(null);
                            }}
                            onUpdate={loadOrders}
                        />
                    )}
                </div>
            );
        }

        // Componente Card Aguardando
        function CardAguardando({ order, position, onIniciar, onCancelar }) {
            const getServicos = () => {
                const servicos = [];
                if (order.oleoMotor) servicos.push(`√ìleo Motor (${order.oleoTipo || 'N/A'})`);
                if (order.filtroOleo) servicos.push(`Filtro √ìleo (${order.filtroTipo || 'N/A'})`);
                if (order.arMotor) servicos.push('Filtro Ar Motor');
                if (order.arCondicionado) servicos.push('Filtro Ar Condicionado');
                if (order.filtroCombustivel) servicos.push('Filtro Combust√≠vel');
                if (order.cambioManual) servicos.push('C√¢mbio Manual');
                if (order.cambioAutomatico) servicos.push('C√¢mbio Autom√°tico');
                if (order.palhetas) servicos.push('Palhetas');
                if (order.militec) servicos.push('Militec/Nano');
                if (order.aditivo) servicos.push('Aditivo');
                if (order.flush) servicos.push('Flush');
                return servicos;
            };

            const servicos = getServicos();

            return (
                <div className="card card-aguardando">
                    <div className="card-header">
                        <span className="order-number">#{order.numeroOrdem}</span>
                        <span className="queue-position">Posi√ß√£o {position}</span>
                        <button className="close-btn" onClick={onCancelar} style={{ color: '#f56565' }}>‚úï</button>
                    </div>
                    <div className="card-title">{order.placa}</div>
                    <div className="card-info">
                        <div className="info-row">
                            <span className="info-label">Cliente:</span>
                            <span>{order.cliente}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Ve√≠culo:</span>
                            <span>{order.marca} {order.modelo}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Motor:</span>
                            <span>{order.motor || 'N/A'}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Vendedor:</span>
                            <span>{order.vendedor}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Registro:</span>
                            <span>{order.dataHora ? new Date(order.dataHora).toLocaleString('pt-BR') : 'N/A'}</span>
                        </div>
                    </div>
                    {servicos.length > 0 && (
                        <div className="services-list">
                            <div style={{ fontWeight: 'bold', marginBottom: '8px', color: '#2d3748' }}>Servi√ßos:</div>
                            {servicos.map((s, i) => (
                                <div key={i} className="service-item">‚Ä¢ {s}</div>
                            ))}
                        </div>
                    )}
                    <div className="card-actions">
                        <button className="btn btn-success" onClick={onIniciar} style={{ flex: 1 }}>
                            ‚ñ∂Ô∏è Iniciar
                        </button>
                    </div>
                </div>
            );
        }

        // Componente Card Conclu√≠do
        function CardConcluido({ order, onVer }) {
            return (
                <div className="card card-concluido">
                    <div className="card-header">
                        <span className="order-number">#{order.numeroOrdem}</span>
                        {order.fezUpsell && (
                            <span className="badge badge-upsell">üí∞ Upsell +R$ {order.valorUpsell?.toFixed(2)}</span>
                        )}
                        {order.voltouComProblema && (
                            <span className="badge badge-problem">‚ö†Ô∏è Retornou</span>
                        )}
                    </div>
                    <div className="card-title">{order.placa}</div>
                    <div className="card-info">
                        <div className="info-row">
                            <span className="info-label">Cliente:</span>
                            <span>{order.cliente}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Ve√≠culo:</span>
                            <span>{order.marca} {order.modelo}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Motor:</span>
                            <span>{order.motor || 'N/A'}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Lubrificador:</span>
                            <span>{order.lubrificador}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Registro:</span>
                            <span>{order.dataHora ? new Date(order.dataHora).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' }) : 'N/A'}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">In√≠cio:</span>
                            <span>{order.inicio || 'N/A'}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Fim:</span>
                            <span>{order.fim || 'N/A'}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Valor Inicial:</span>
                            <span>R$ {parseFloat(order.valorInicial || 0).toFixed(2)}</span>
                        </div>
                        <div className="info-row">
                            <span className="info-label">Valor Total:</span>
                            <span style={{ fontWeight: 'bold', color: '#667eea' }}>R$ {parseFloat(order.valorTotal || 0).toFixed(2)}</span>
                        </div>
                    </div>
                    <div className="card-actions">
                        <button className="btn btn-primary" onClick={onVer} style={{ flex: 1 }}>
                            üëÅÔ∏è Ver Detalhes
                        </button>
                    </div>
                </div>
            );
        }

        // Modal Nova Ordem
        function NovaOrdemModal({ onClose, onSuccess, nextOrderNumber }) {
            const [step, setStep] = useState(1);
            const [formData, setFormData] = useState({
                numeroOrdem: nextOrderNumber,
                status: 'aguardando',
                vendedor: '',
                cliente: '',
                tel: '',
                cpf: '',
                dataNascimento: '',
                placa: '',
                marca: '',
                modelo: '',
                motor: '',
                ano: '',
                cambio: '',
                combustivel: '',
                dataHora: formatDateTimeForInput(),
                
                oleoMotor: false,
                oleoMarca: '',
                oleoQuantidade: '',
                filtroOleo: false,
                filtroOleoTipo: '',
                arMotor: false,
                arMotorCodigo: '',
                arCondicionado: false,
                arCondicionadoCodigo: '',
                filtroCombustivel: false,
                filtroCombustivelCodigo: '',
                cambioManual: false,
                cambioManualMarca: '',
                cambioManualQuantidade: '',
                cambioAutomatico: false,
                cambioAutomaticoMarca: '',
                cambioAutomaticoQuantidade: '',
                cambioAutomaticoTemFiltro: false,
                cambioAutomaticoFiltroCodigo: '',
                palhetas: false,
                palhetasCodigo: '',
                militec: false,
                aditivo: false,
                aditivoQual: '',
                flush: false,
                flushDescricao: '',
                
                apto: 'sim',
                motivoNaoApto: '',
                valorInicial: ''
            });

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: type === 'checkbox' ? checked : value
                }));
            };

            const validateStep1 = () => {
                if (!formData.vendedor || !formData.cliente || !formData.placa) {
                    alert('Preencha os campos obrigat√≥rios: Vendedor, Cliente e Placa');
                    return false;
                }
                
                const placaRegex = /^[A-Z]{3}-?\d{4}$|^[A-Z]{3}\d[A-Z]\d{2}$/;
                if (!placaRegex.test(formData.placa.toUpperCase())) {
                    alert('Placa inv√°lida. Use formato AAA-1234 ou AAA1A23');
                    return false;
                }
                
                if (formData.tel && formData.tel.length < 10) {
                    alert('Telefone inv√°lido');
                    return false;
                }
                
                return true;
            };

            const validateStep2 = () => {
                const hasService = formData.oleoMotor || formData.filtroOleo || formData.arMotor || 
                                  formData.arCondicionado || formData.filtroCombustivel || 
                                  formData.cambioManual || formData.cambioAutomatico || 
                                  formData.palhetas || formData.militec || formData.aditivo || formData.flush;
                
                if (!hasService) {
                    alert('Selecione pelo menos um servi√ßo');
                    return false;
                }
                
                return true;
            };

            const validateStep3 = () => {
                if (!formData.valorInicial || parseFloat(formData.valorInicial) <= 0) {
                    alert('Preencha o valor inicial da venda');
                    return false;
                }
                
                if (formData.apto === 'nao' && !formData.motivoNaoApto) {
                    alert('Informe o motivo do cliente n√£o ser apto para ofertas');
                    return false;
                }
                
                return true;
            };

            const handleNext = () => {
                if (step === 1 && !validateStep1()) return;
                if (step === 2 && !validateStep2()) return;
                if (step < 3) setStep(step + 1);
            };

            const handleSubmit = async () => {
                if (!validateStep3()) return;
                
                try {
                    const orderData = {
                        ...formData,
                        dataHora: new Date(formData.dataHora).toISOString(),
                        placa: formData.placa.toUpperCase(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await db.collection('orders').add(orderData);
                    alert('Ordem criada com sucesso!');
                    onSuccess();
                } catch (error) {
                    console.error('Erro ao criar ordem:', error);
                    alert('Erro ao criar ordem. Tente novamente.');
                }
            };

            return (
                <div className="modal">
                    <div className="modal-content">
                        <div className="modal-header">
                            <div className="modal-title">Nova Ordem #{nextOrderNumber}</div>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>
                        
                        <div className="modal-body">
                            <div className="step-indicator">
                                <div className={`step ${step >= 1 ? 'active' : ''} ${step > 1 ? 'completed' : ''}`}>
                                    <div className="step-number">1</div>
                                    <div className="step-label">Cliente</div>
                                </div>
                                <div className={`step ${step >= 2 ? 'active' : ''} ${step > 2 ? 'completed' : ''}`}>
                                    <div className="step-number">2</div>
                                    <div className="step-label">Servi√ßos</div>
                                </div>
                                <div className={`step ${step >= 3 ? 'active' : ''}`}>
                                    <div className="step-number">3</div>
                                    <div className="step-label">Finaliza√ß√£o</div>
                                </div>
                            </div>

                            {step === 1 && (
                                <div>
                                    <div className="form-group">
                                        <label className="form-label">Vendedor *</label>
                                        <select name="vendedor" value={formData.vendedor} onChange={handleChange} className="form-select" required>
                                            <option value="">Selecione...</option>
                                            <option value="Caio">Caio</option>
                                            <option value="Carlos">Carlos</option>
                                            <option value="Faust">Faust</option>
                                            <option value="Luis">Luis</option>
                                        </select>
                                    </div>

                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Nome do Cliente *</label>
                                            <input type="text" name="cliente" value={formData.cliente} onChange={handleChange} className="form-input" required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Data/Hora</label>
                                            <input type="datetime-local" name="dataHora" value={formData.dataHora} onChange={handleChange} className="form-input" />
                                        </div>
                                    </div>

                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Telefone</label>
                                            <input type="tel" name="tel" value={formData.tel} onChange={handleChange} className="form-input" placeholder="(00) 00000-0000" />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">CPF/CNPJ</label>
                                            <input type="text" name="cpf" value={formData.cpf} onChange={handleChange} className="form-input" placeholder="000.000.000-00" />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Data de Nascimento</label>
                                            <input type="date" name="dataNascimento" value={formData.dataNascimento} onChange={handleChange} className="form-input" />
                                        </div>
                                    </div>

                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Placa *</label>
                                            <input type="text" name="placa" value={formData.placa} onChange={handleChange} className="form-input" placeholder="ABC-1234 ou ABC1D23" maxLength="8" required />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Marca</label>
                                            <input type="text" name="marca" value={formData.marca} onChange={handleChange} className="form-input" />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Modelo</label>
                                            <input type="text" name="modelo" value={formData.modelo} onChange={handleChange} className="form-input" />
                                        </div>
                                    </div>

                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Motor</label>
                                            <input type="text" name="motor" value={formData.motor} onChange={handleChange} className="form-input" placeholder="Ex: 1.0, 1.6, 2.0" />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Ano</label>
                                            <input type="number" name="ano" value={formData.ano} onChange={handleChange} className="form-input" placeholder="2024" />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">C√¢mbio</label>
                                            <select name="cambio" value={formData.cambio} onChange={handleChange} className="form-select">
                                                <option value="">Selecione...</option>
                                                <option value="Manual">Manual</option>
                                                <option value="Autom√°tico">Autom√°tico</option>
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Combust√≠vel</label>
                                            <select name="combustivel" value={formData.combustivel} onChange={handleChange} className="form-select">
                                                <option value="">Selecione...</option>
                                                <option value="Gasolina">Gasolina</option>
                                                <option value="Diesel">Diesel</option>
                                                <option value="Flex">Flex</option>
                                                <option value="GNV">GNV</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {step === 2 && (
                                <div>
                                    <div className="section-title">Selecione os Servi√ßos</div>
                                    
                                    <div className="checkbox-group">
                                        <input type="checkbox" id="oleoMotor" name="oleoMotor" checked={formData.oleoMotor} onChange={handleChange} />
                                        <label htmlFor="oleoMotor">√ìleo de Motor</label>
                                    </div>
                                    {formData.oleoMotor && (
                                        <div className="form-row" style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">Marca do √ìleo</label>
                                                <input type="text" name="oleoMarca" value={formData.oleoMarca} onChange={handleChange} className="form-input" placeholder="Ex: Mobil" />
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Quantidade (L)</label>
                                                <input type="number" step="0.01" name="oleoQuantidade" value={formData.oleoQuantidade} onChange={handleChange} className="form-input" placeholder="Ex: 4.5" />
                                            </div>
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="filtroOleo" name="filtroOleo" checked={formData.filtroOleo} onChange={handleChange} />
                                        <label htmlFor="filtroOleo">Filtro de √ìleo</label>
                                    </div>
                                    {formData.filtroOleo && (
                                        <div style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">Tipo do Filtro</label>
                                                <input type="text" name="filtroOleoTipo" value={formData.filtroOleoTipo} onChange={handleChange} className="form-input" placeholder="Ex: Tecfil PSL140" />
                                            </div>
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="arMotor" name="arMotor" checked={formData.arMotor} onChange={handleChange} />
                                        <label htmlFor="arMotor">Filtro Ar Motor</label>
                                    </div>
                                    {formData.arMotor && (
                                        <div style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">C√≥digo do Filtro</label>
                                                <input type="text" name="arMotorCodigo" value={formData.arMotorCodigo} onChange={handleChange} className="form-input" placeholder="Ex: ARS9123" />
                                            </div>
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="arCondicionado" name="arCondicionado" checked={formData.arCondicionado} onChange={handleChange} />
                                        <label htmlFor="arCondicionado">Filtro Ar Condicionado</label>
                                    </div>
                                    {formData.arCondicionado && (
                                        <div style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">C√≥digo do Filtro</label>
                                                <input type="text" name="arCondicionadoCodigo" value={formData.arCondicionadoCodigo} onChange={handleChange} className="form-input" placeholder="Ex: ARC8765" />
                                            </div>
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="filtroCombustivel" name="filtroCombustivel" checked={formData.filtroCombustivel} onChange={handleChange} />
                                        <label htmlFor="filtroCombustivel">Filtro de Combust√≠vel</label>
                                    </div>
                                    {formData.filtroCombustivel && (
                                        <div style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">C√≥digo do Filtro</label>
                                                <input type="text" name="filtroCombustivelCodigo" value={formData.filtroCombustivelCodigo} onChange={handleChange} className="form-input" placeholder="Ex: FC9432" />
                                            </div>
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="cambioManual" name="cambioManual" checked={formData.cambioManual} onChange={handleChange} />
                                        <label htmlFor="cambioManual">Troca C√¢mbio Manual</label>
                                    </div>
                                    {formData.cambioManual && (
                                        <div className="form-row" style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">Marca do √ìleo</label>
                                                <input type="text" name="cambioManualMarca" value={formData.cambioManualMarca} onChange={handleChange} className="form-input" placeholder="Ex: Motul" />
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Quantidade (L)</label>
                                                <input type="number" step="0.01" name="cambioManualQuantidade" value={formData.cambioManualQuantidade} onChange={handleChange} className="form-input" placeholder="Ex: 2.0" />
                                            </div>
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="cambioAutomatico" name="cambioAutomatico" checked={formData.cambioAutomatico} onChange={handleChange} />
                                        <label htmlFor="cambioAutomatico">Troca C√¢mbio Autom√°tico</label>
                                    </div>
                                    {formData.cambioAutomatico && (
                                        <div style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-row">
                                                <div className="form-group">
                                                    <label className="form-label">Marca do √ìleo</label>
                                                    <input type="text" name="cambioAutomaticoMarca" value={formData.cambioAutomaticoMarca} onChange={handleChange} className="form-input" placeholder="Ex: Shell" />
                                                </div>
                                                <div className="form-group">
                                                    <label className="form-label">Quantidade (L)</label>
                                                    <input type="number" step="0.01" name="cambioAutomaticoQuantidade" value={formData.cambioAutomaticoQuantidade} onChange={handleChange} className="form-input" placeholder="Ex: 4.0" />
                                                </div>
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Tem filtro?</label>
                                                <select name="cambioAutomaticoTemFiltro" value={formData.cambioAutomaticoTemFiltro} onChange={handleChange} className="form-select">
                                                    <option value={false}>N√£o</option>
                                                    <option value={true}>Sim</option>
                                                </select>
                                            </div>
                                            {formData.cambioAutomaticoTemFiltro === 'true' && (
                                                <div className="form-group">
                                                    <label className="form-label">C√≥digo do Filtro</label>
                                                    <input type="text" name="cambioAutomaticoFiltroCodigo" value={formData.cambioAutomaticoFiltroCodigo} onChange={handleChange} className="form-input" placeholder="Ex: CAF5678" />
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="palhetas" name="palhetas" checked={formData.palhetas} onChange={handleChange} />
                                        <label htmlFor="palhetas">Troca de Palhetas</label>
                                    </div>
                                    {formData.palhetas && (
                                        <div style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">C√≥digo</label>
                                                <input type="text" name="palhetasCodigo" value={formData.palhetasCodigo} onChange={handleChange} className="form-input" placeholder="Ex: PAL2226" />
                                            </div>
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="militec" name="militec" checked={formData.militec} onChange={handleChange} />
                                        <label htmlFor="militec">Militec/Nano</label>
                                    </div>

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="aditivo" name="aditivo" checked={formData.aditivo} onChange={handleChange} />
                                        <label htmlFor="aditivo">Aditivo</label>
                                    </div>
                                    {formData.aditivo && (
                                        <div style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">Qual Aditivo?</label>
                                                <input type="text" name="aditivoQual" value={formData.aditivoQual} onChange={handleChange} className="form-input" placeholder="Ex: STP" />
                                            </div>
                                        </div>
                                    )}

                                    <div className="checkbox-group">
                                        <input type="checkbox" id="flush" name="flush" checked={formData.flush} onChange={handleChange} />
                                        <label htmlFor="flush">Flush</label>
                                    </div>
                                    {formData.flush && (
                                        <div style={{ marginLeft: '30px', marginBottom: '15px' }}>
                                            <div className="form-group">
                                                <label className="form-label">Descri√ß√£o</label>
                                                <textarea name="flushDescricao" value={formData.flushDescricao} onChange={handleChange} className="form-textarea" placeholder="Descreva o servi√ßo de flush" rows="3"></textarea>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {step === 3 && (
                                <div>
                                    <div className="form-group">
                                        <label className="form-label">Cliente est√° apto para receber ofertas? *</label>
                                        <select name="apto" value={formData.apto} onChange={handleChange} className="form-select" required>
                                            <option value="sim">Sim</option>
                                            <option value="nao">N√£o</option>
                                        </select>
                                    </div>

                                    {formData.apto === 'nao' && (
                                        <div className="form-group">
                                            <label className="form-label">Motivo *</label>
                                            <textarea name="motivoNaoApto" value={formData.motivoNaoApto} onChange={handleChange} className="form-textarea" placeholder="Por que o cliente n√£o est√° apto?" required></textarea>
                                        </div>
                                    )}

                                    <div className="form-group">
                                        <label className="form-label">Valor da Venda Inicial (R$) *</label>
                                        <input type="number" step="0.01" name="valorInicial" value={formData.valorInicial} onChange={handleChange} className="form-input" placeholder="0.00" required />
                                    </div>

                                    <div className="alert alert-info">
                                        <strong>Resumo da Ordem</strong>
                                        <div style={{ marginTop: '10px' }}>
                                            <div><strong>Cliente:</strong> {formData.cliente}</div>
                                            <div><strong>Placa:</strong> {formData.placa}</div>
                                            <div><strong>Ve√≠culo:</strong> {formData.marca} {formData.modelo}</div>
                                            <div><strong>Vendedor:</strong> {formData.vendedor}</div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div style={{ display: 'flex', gap: '15px', marginTop: '30px', justifyContent: 'space-between' }}>
                                {step > 1 && (
                                    <button className="btn btn-secondary" onClick={() => setStep(step - 1)}>
                                        ‚Üê Voltar
                                    </button>
                                )}
                                {step < 3 ? (
                                    <button className="btn btn-primary" onClick={handleNext} style={{ marginLeft: 'auto' }}>
                                        Pr√≥ximo ‚Üí
                                    </button>
                                ) : (
                                    <button className="btn btn-success" onClick={handleSubmit} style={{ marginLeft: 'auto' }}>
                                        ‚úì Criar Ordem
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Modal Executar Servi√ßo
        function ExecutarServicoModal({ order, onClose, onSuccess }) {
            const [step, setStep] = useState(1);
            const [formData, setFormData] = useState({
                lubrificador: '',
                inicio: getBrasilDateTime(),
                km: '',
                fotos: [],
                upsells: {},
                obsCarro: '',
                obsOferta: '',
                valorAdd: '0'
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: value
                }));
            };

            const handleUpsellChange = (servico, field, value) => {
                setFormData(prev => ({
                    ...prev,
                    upsells: {
                        ...prev.upsells,
                        [servico]: {
                            ...prev.upsells[servico],
                            [field]: value
                        }
                    }
                }));
            };

            const calcularValorUpsell = () => {
                let total = 0;
                Object.values(formData.upsells).forEach(upsell => {
                    if (upsell.oferecido && upsell.aceito === 'sim' && upsell.valor) {
                        total += parseFloat(upsell.valor) || 0;
                    }
                });
                return total;
            };

            const handleFinalizar = async () => {
                if (!formData.lubrificador) {
                    alert('Selecione o lubrificador');
                    return;
                }

                if (!formData.km) {
                    alert('Informe a quilometragem do ve√≠culo');
                    return;
                }

                try {
                    const fim = getBrasilDateTime();
                    const valorUpsell = calcularValorUpsell();
                    const valorTotal = parseFloat(order.valorInicial || 0) + valorUpsell;
                    const quantidadeItensUpsell = Object.values(formData.upsells).filter(u => u.oferecido && u.aceito === 'sim').length;

                    const updateData = {
                        ...formData,
                        status: 'concluido',
                        fim,
                        valorUpsell,
                        valorTotal,
                        fezUpsell: quantidadeItensUpsell > 0,
                        quantidadeItensUpsell,
                        tempoEspera: order.dataHora && formData.inicio ? calcularDiferencaTempo(
                            new Date(order.dataHora).toLocaleString('pt-BR'),
                            formData.inicio
                        ) : 'N/A',
                        tempoServico: calcularDiferencaTempo(formData.inicio, fim)
                    };

                    await db.collection('orders').doc(order.id).update(updateData);
                    alert('Servi√ßo finalizado com sucesso!');
                    onSuccess();
                } catch (error) {
                    console.error('Erro ao finalizar servi√ßo:', error);
                    alert('Erro ao finalizar servi√ßo.');
                }
            };

            // Servi√ßos dispon√≠veis para upsell
            const servicosDisponiveis = [];
            if (!order.oleoMotor) servicosDisponiveis.push({ key: 'oleoMotor', label: '√ìleo de Motor' });
            if (!order.filtroOleo) servicosDisponiveis.push({ key: 'filtroOleo', label: 'Filtro de √ìleo' });
            if (!order.arMotor) servicosDisponiveis.push({ key: 'arMotor', label: 'Filtro Ar Motor' });
            if (!order.arCondicionado) servicosDisponiveis.push({ key: 'arCondicionado', label: 'Filtro Ar Condicionado' });
            if (!order.filtroCombustivel) servicosDisponiveis.push({ key: 'filtroCombustivel', label: 'Filtro Combust√≠vel' });

            return (
                <div className="modal">
                    <div className="modal-content">
                        <div className="modal-header">
                            <div className="modal-title">Executar Servi√ßo - Ordem #{order.numeroOrdem}</div>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>
                        
                        <div className="modal-body">
                            {step === 1 && (
                                <div>
                                    <div className="alert alert-info">
                                        <div><strong>Placa:</strong> {order.placa}</div>
                                        <div><strong>Ve√≠culo:</strong> {order.marca} {order.modelo} {order.motor}</div>
                                        <div><strong>Ano:</strong> {order.ano}</div>
                                        <div><strong>Cliente:</strong> {order.cliente}</div>
                                        <div><strong>Vendedor:</strong> {order.vendedor}</div>
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label">Lubrificador *</label>
                                        <select name="lubrificador" value={formData.lubrificador} onChange={handleChange} className="form-select" required>
                                            <option value="">Selecione...</option>
                                            <option value="Caio">Caio</option>
                                            <option value="Luis">Luis</option>
                                        </select>
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label">Quilometragem (KM) *</label>
                                        <input type="number" name="km" value={formData.km} onChange={handleChange} className="form-input" placeholder="Ex: 45000" required />
                                    </div>

                                    <div className="section-title">Servi√ßos a Realizar</div>
                                    <div className="services-list">
                                        {order.oleoMotor && <div className="service-item">‚úì √ìleo Motor ({order.oleoMarca} - {order.oleoQuantidade}L)</div>}
                                        {order.filtroOleo && <div className="service-item">‚úì Filtro √ìleo ({order.filtroOleoTipo})</div>}
                                        {order.arMotor && <div className="service-item">‚úì Filtro Ar Motor ({order.arMotorCodigo})</div>}
                                        {order.arCondicionado && <div className="service-item">‚úì Filtro Ar Condicionado ({order.arCondicionadoCodigo})</div>}
                                        {order.filtroCombustivel && <div className="service-item">‚úì Filtro Combust√≠vel ({order.filtroCombustivelCodigo})</div>}
                                        {order.cambioManual && <div className="service-item">‚úì C√¢mbio Manual ({order.cambioManualMarca} - {order.cambioManualQuantidade}L)</div>}
                                        {order.cambioAutomatico && <div className="service-item">‚úì C√¢mbio Autom√°tico ({order.cambioAutomaticoMarca} - {order.cambioAutomaticoQuantidade}L)</div>}
                                        {order.palhetas && <div className="service-item">‚úì Palhetas ({order.palhetasCodigo})</div>}
                                        {order.militec && <div className="service-item">‚úì Militec/Nano</div>}
                                        {order.aditivo && <div className="service-item">‚úì Aditivo ({order.aditivoQual})</div>}
                                        {order.flush && <div className="service-item">‚úì Flush</div>}
                                    </div>

                                    {order.apto === 'sim' ? (
                                        <div className="alert alert-success">
                                            <strong>‚úÖ CLIENTE ACEITA OFERTAS!</strong>
                                            <div>Ofere√ßa servi√ßos adicionais na pr√≥xima etapa</div>
                                        </div>
                                    ) : (
                                        <div className="alert alert-danger">
                                            <strong>‚ùå N√ÉO OFERECER SERVI√áOS EXTRAS</strong>
                                            <div>Motivo: {order.motivoNaoApto}</div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {step === 2 && order.apto === 'sim' && (
                                <div>
                                    <div className="section-title">Ofertas Adicionais (Upsell)</div>
                                    
                                    {servicosDisponiveis.length === 0 ? (
                                        <div className="alert alert-info">
                                            Todos os servi√ßos j√° foram vendidos pelo vendedor.
                                        </div>
                                    ) : (
                                        servicosDisponiveis.map(({ key, label }) => (
                                            <div key={key} style={{ marginBottom: '20px', padding: '15px', background: '#f7fafc', borderRadius: '8px' }}>
                                                <div className="checkbox-group">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={formData.upsells[key]?.oferecido || false}
                                                        onChange={(e) => handleUpsellChange(key, 'oferecido', e.target.checked)}
                                                    />
                                                    <label style={{ fontWeight: 'bold' }}>{label}</label>
                                                </div>
                                                
                                                {formData.upsells[key]?.oferecido && (
                                                    <div style={{ marginTop: '10px', marginLeft: '30px' }}>
                                                        {['arMotor', 'arCondicionado', 'filtroCombustivel'].includes(key) && (
                                                            <div className="form-group">
                                                                <label className="form-label">URL da Foto</label>
                                                                <input 
                                                                    type="url" 
                                                                    className="form-input"
                                                                    placeholder="Cole a URL da foto aqui"
                                                                    value={formData.upsells[key]?.foto || ''}
                                                                    onChange={(e) => handleUpsellChange(key, 'foto', e.target.value)}
                                                                />
                                                            </div>
                                                        )}
                                                        
                                                        <div className="form-group">
                                                            <label className="form-label">Cliente aceitou?</label>
                                                            <select 
                                                                className="form-select"
                                                                value={formData.upsells[key]?.aceito || ''}
                                                                onChange={(e) => handleUpsellChange(key, 'aceito', e.target.value)}
                                                            >
                                                                <option value="">Selecione...</option>
                                                                <option value="sim">Sim</option>
                                                                <option value="nao">N√£o</option>
                                                            </select>
                                                        </div>

                                                        {formData.upsells[key]?.aceito === 'sim' && (
                                                            <div className="form-group">
                                                                <label className="form-label">Valor (R$)</label>
                                                                <input 
                                                                    type="number" 
                                                                    step="0.01"
                                                                    className="form-input"
                                                                    placeholder="0.00"
                                                                    value={formData.upsells[key]?.valor || ''}
                                                                    onChange={(e) => handleUpsellChange(key, 'valor', e.target.value)}
                                                                />
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        ))
                                    )}
                                </div>
                            )}

                            {(step === 3 || (step === 2 && order.apto !== 'sim')) && (
                                <div>
                                    <div className="form-group">
                                        <label className="form-label">Observa√ß√µes sobre o Carro</label>
                                        <textarea 
                                            name="obsCarro" 
                                            value={formData.obsCarro} 
                                            onChange={handleChange} 
                                            className="form-textarea" 
                                            placeholder="Ex: Vazamento de √≥leo, pneus gastos..."
                                            rows="3"
                                        ></textarea>
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label">Observa√ß√µes sobre Ofertas</label>
                                        <textarea 
                                            name="obsOferta" 
                                            value={formData.obsOferta} 
                                            onChange={handleChange} 
                                            className="form-textarea" 
                                            placeholder="Ex: N√£o tinha filtro em estoque, cliente recusou servi√ßo..."
                                            rows="3"
                                        ></textarea>
                                    </div>

                                    <div className="value-display">
                                        <div className="value-row">
                                            <span className="value-label">Valor Inicial:</span>
                                            <span className="value-amount">R$ {parseFloat(order.valorInicial || 0).toFixed(2)}</span>
                                        </div>
                                        {calcularValorUpsell() > 0 && (
                                            <div className="value-row">
                                                <span className="value-label">Valor Adicional (Upsell):</span>
                                                <span className="value-amount">+ R$ {calcularValorUpsell().toFixed(2)}</span>
                                            </div>
                                        )}
                                        <div className="value-row value-total">
                                            <span className="value-label">TOTAL:</span>
                                            <span className="value-amount">R$ {(parseFloat(order.valorInicial || 0) + calcularValorUpsell()).toFixed(2)}</span>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div style={{ display: 'flex', gap: '15px', marginTop: '30px', justifyContent: 'space-between' }}>
                                {step > 1 && (
                                    <button className="btn btn-secondary" onClick={() => setStep(step - 1)}>
                                        ‚Üê Voltar
                                    </button>
                                )}
                                {(step === 1 || (step === 2 && order.apto === 'sim' && servicosDisponiveis.length > 0)) ? (
                                    <button className="btn btn-primary" onClick={() => setStep(step + 1)} style={{ marginLeft: 'auto' }}>
                                        Pr√≥ximo ‚Üí
                                    </button>
                                ) : (
                                    <button className="btn btn-success" onClick={handleFinalizar} style={{ marginLeft: 'auto' }}>
                                        ‚úì Finalizar Servi√ßo
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Modal Detalhes
        function DetalhesModal({ order, onClose, onUpdate }) {
            const [editMode, setEditMode] = useState(false);
            const [formData, setFormData] = useState({
                valorInicial: order.valorInicial || '',
                valorUpsell: order.valorUpsell || 0,
                obsCarro: order.obsCarro || '',
                obsOferta: order.obsOferta || '',
                voltouComProblema: order.voltouComProblema || false
            });

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: type === 'checkbox' ? checked : value
                }));
            };

            const handleSave = async () => {
                try {
                    const valorTotal = parseFloat(formData.valorInicial || 0) + parseFloat(formData.valorUpsell || 0);
                    await db.collection('orders').doc(order.id).update({
                        ...formData,
                        valorTotal
                    });
                    alert('Altera√ß√µes salvas com sucesso!');
                    setEditMode(false);
                    onUpdate();
                } catch (error) {
                    console.error('Erro ao salvar:', error);
                    alert('Erro ao salvar altera√ß√µes.');
                }
            };

            return (
                <div className="modal">
                    <div className="modal-content">
                        <div className="modal-header">
                            <div className="modal-title">Detalhes - Ordem #{order.numeroOrdem}</div>
                            <button className="close-btn" onClick={onClose}>‚úï</button>
                        </div>
                        
                        <div className="modal-body">
                            <div className="section-title">Informa√ß√µes Gerais</div>
                            <div className="info-row">
                                <span className="info-label">Status:</span>
                                <span style={{ 
                                    color: order.status === 'aguardando' ? '#f6ad55' : '#48bb78',
                                    fontWeight: 'bold'
                                }}>
                                    {order.status === 'aguardando' ? 'üü° Aguardando' : 'üü¢ Conclu√≠do'}
                                </span>
                            </div>
                            <div className="info-row">
                                <span className="info-label">Placa:</span>
                                <span>{order.placa}</span>
                            </div>
                            <div className="info-row">
                                <span className="info-label">Cliente:</span>
                                <span>{order.cliente}</span>
                            </div>
                            <div className="info-row">
                                <span className="info-label">Ve√≠culo:</span>
                                <span>{order.marca} {order.modelo} {order.motor} ({order.ano})</span>
                            </div>
                            <div className="info-row">
                                <span className="info-label">Combust√≠vel:</span>
                                <span>{order.combustivel}</span>
                            </div>
                            <div className="info-row">
                                <span className="info-label">Vendedor:</span>
                                <span>{order.vendedor}</span>
                            </div>
                            {order.lubrificador && (
                                <div className="info-row">
                                    <span className="info-label">Lubrificador:</span>
                                    <span>{order.lubrificador}</span>
                                </div>
                            )}

                            <div className="section-title">Tempos</div>
                            <div className="info-row">
                                <span className="info-label">Registro:</span>
                                <span>{order.dataHora ? new Date(order.dataHora).toLocaleString('pt-BR') : 'N/A'}</span>
                            </div>
                            {order.inicio && (
                                <>
                                    <div className="info-row">
                                        <span className="info-label">In√≠cio do Servi√ßo:</span>
                                        <span>{order.inicio}</span>
                                    </div>
                                    <div className="info-row">
                                        <span className="info-label">Fim do Servi√ßo:</span>
                                        <span>{order.fim || 'N/A'}</span>
                                    </div>
                                    {order.tempoEspera && (
                                        <div className="info-row">
                                            <span className="info-label">Tempo de Espera:</span>
                                            <span style={{ fontWeight: 'bold', color: '#f6ad55' }}>{order.tempoEspera}</span>
                                        </div>
                                    )}
                                    {order.tempoServico && (
                                        <div className="info-row">
                                            <span className="info-label">Tempo de Servi√ßo:</span>
                                            <span style={{ fontWeight: 'bold', color: '#48bb78' }}>{order.tempoServico}</span>
                                        </div>
                                    )}
                                </>
                            )}

                            <div className="section-title">Valores</div>
                            <div className="value-display">
                                <div className="value-row">
                                    <span className="value-label">Valor Inicial:</span>
                                    {editMode ? (
                                        <input 
                                            type="number" 
                                            step="0.01"
                                            name="valorInicial"
                                            value={formData.valorInicial}
                                            onChange={handleChange}
                                            className="form-input"
                                            style={{ width: '150px' }}
                                        />
                                    ) : (
                                        <span className="value-amount">R$ {parseFloat(order.valorInicial || 0).toFixed(2)}</span>
                                    )}
                                </div>
                                {order.valorUpsell > 0 && (
                                    <div className="value-row">
                                        <span className="value-label">Valor Adicional (Upsell):</span>
                                        <span className="value-amount">+ R$ {parseFloat(order.valorUpsell || 0).toFixed(2)}</span>
                                    </div>
                                )}
                                <div className="value-row value-total">
                                    <span className="value-label">TOTAL:</span>
                                    <span className="value-amount">R$ {parseFloat(order.valorTotal || order.valorInicial || 0).toFixed(2)}</span>
                                </div>
                            </div>

                            {order.obsCarro && (
                                <>
                                    <div className="section-title">Observa√ß√µes do Carro</div>
                                    {editMode ? (
                                        <textarea 
                                            name="obsCarro"
                                            value={formData.obsCarro}
                                            onChange={handleChange}
                                            className="form-textarea"
                                            rows="3"
                                        ></textarea>
                                    ) : (
                                        <div style={{ padding: '15px', background: '#f7fafc', borderRadius: '8px' }}>
                                            {order.obsCarro}
                                        </div>
                                    )}
                                </>
                            )}

                            {order.obsOferta && (
                                <>
                                    <div className="section-title">Observa√ß√µes sobre Ofertas</div>
                                    {editMode ? (
                                        <textarea 
                                            name="obsOferta"
                                            value={formData.obsOferta}
                                            onChange={handleChange}
                                            className="form-textarea"
                                            rows="3"
                                        ></textarea>
                                    ) : (
                                        <div style={{ padding: '15px', background: '#f7fafc', borderRadius: '8px' }}>
                                            {order.obsOferta}
                                        </div>
                                    )}
                                </>
                            )}

                            {order.status === 'concluido' && (
                                <div className="form-group" style={{ marginTop: '20px' }}>
                                    <div className="checkbox-group">
                                        <input 
                                            type="checkbox"
                                            id="voltouComProblema"
                                            name="voltouComProblema"
                                            checked={formData.voltouComProblema}
                                            onChange={handleChange}
                                            disabled={!editMode}
                                        />
                                        <label htmlFor="voltouComProblema" style={{ color: '#f56565', fontWeight: 'bold' }}>
                                            ‚ö†Ô∏è Cliente voltou com problema
                                        </label>
                                    </div>
                                </div>
                            )}

                            <div style={{ display: 'flex', gap: '15px', marginTop: '30px' }}>
                                {editMode ? (
                                    <>
                                        <button className="btn btn-secondary" onClick={() => setEditMode(false)}>
                                            Cancelar
                                        </button>
                                        <button className="btn btn-success" onClick={handleSave}>
                                            üíæ Salvar
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        <button className="btn btn-secondary" onClick={onClose}>
                                            Fechar
                                        </button>
                                        <button className="btn btn-primary" onClick={() => setEditMode(true)}>
                                            ‚úèÔ∏è Editar
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Renderizar aplica√ß√£o
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
